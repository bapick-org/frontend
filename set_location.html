<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>위치 설정 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=85cfe1eb44a56817dcedc87a46b5070b&libraries=services,places"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="custom-toast"
        class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>
    
    <header class="grid grid-cols-3 items-center bg-white p-4 shadow-md z-10">
        <div class="justify-self-start">
            <a href="javascript:history.back()" class="text-gray-600 hover:bg-gray-100 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
            </a>
        </div>
        <div class="justify-self-center text-lg font-bold">위치 설정</div>
        <div class="justify-self-end">
            <button id="gps-btn" class="p-2 text-orange-600 hover:bg-orange-50 rounded-full" title="현재 위치로 설정">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-crosshair"><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></svg>
            </button>
        </div>
    </header>
    
    <div class="bg-white p-4 border-b z-10">
        <div class="flex gap-2">
            <input type="text" id="address-input" placeholder="장소, 주소 검색"
                    class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#FF7242] focus:outline-none">
            <button id="search-btn"
                    class="bg-[#FF7242] text-white font-bold py-2 px-4 rounded-md hover:bg-orange-600">검색</button>
        </div>
    </div>

    <main class="flex-grow">
        <div id="map"></div>
    </main>
    
    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white bg-opacity-80 backdrop-blur-sm shadow-[0_-2px_10px_rgba(0,0,0,0.1)] z-10">
        <button id="save-location-btn" class="w-full bg-[#FF7242] text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 transition-colors">
            위치 저장
        </button>
    </div>

    <script>
        // 커스텀 토스트 함수 정의
        const customToast = document.getElementById('custom-toast');
        const toastDuration = 2500; 

        function showCustomToast(message) {
            if (!customToast) return;
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

            setTimeout(() => {
                customToast.classList.remove('opacity-100');
                customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mapContainer = document.getElementById('map');
            const saveButton = document.getElementById('save-location-btn');
            const gpsButton = document.getElementById('gps-btn');
            let map, marker;
            let currentLocationData = null; 

            function initMapWithGPS() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(onSuccessGPS, onErrorGPS);
                }
            }

            function onSuccessGPS(position) {
                initializeMap(position.coords.latitude, position.coords.longitude);
            }

            function onErrorGPS(error) {
                showCustomToast("현재 위치를 가져올 수 없습니다.");
                initializeMap(37.566826, 126.9786567);
            }

            function initializeMap(lat, lon) {
                const savedLocationJson = localStorage.getItem('savedBapickLocation');
                let initialLat = lat || 37.566826; // 서울 시청
                let initialLon = lon || 126.978656;
                let initialZoom = 6; // 기본 줌 레벨

                if (savedLocationJson) {
                    try {
                        const savedLocation = JSON.parse(savedLocationJson);
                        initialLat = parseFloat(savedLocation.lat);
                        initialLon = parseFloat(savedLocation.lon);
                        initialZoom = 3; // 저장된 위치일 경우 확대
                    } catch (e) {
                        console.error("Error parsing saved location", e);
                    }
                }

                const mapOption = {
                    center: new kakao.maps.LatLng(initialLat, initialLon),
                    level: initialZoom 
                };
                map = new kakao.maps.Map(document.getElementById('map'), mapOption);
                marker = new kakao.maps.Marker({
                    position: mapOption.center
                });
                marker.setMap(map);
                
                // 저장된 위치가 있을 경우, 해당 위치를 currentLocationData로 설정
                if (savedLocationJson) {
                    currentLocationData = JSON.parse(savedLocationJson);
                }
            }

            // 현재 위치를 기준으로 설정하고, currentLocationData 업데이트
            async function setCurrentLocation() {
                saveButton.textContent = '위치 확인 중...'; // 버튼 텍스트 변경
                saveButton.disabled = true;

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => { 
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            const locPosition = new kakao.maps.LatLng(lat, lon);
                            
                            map.panTo(locPosition);
                            marker.setPosition(locPosition);
                            map.setLevel(3);

                            let fullAddress = '주소 정보 없음';
                            let locationName = '현재 위치';

                            // Reverse geocoding: 좌표와 가장 가까운 주소 반환(Nominatim API 사용)
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ko`);
                                if (!response.ok) {
                                    throw new Error('Reverse geocoding API request failed');
                                }
                                const data = await response.json();
                                const address = data.address;
                            
                                // 주소 파싱 로직 (기존 로직 유지)
                                const city = address.city || address.province || '';
                                const city_district = address.city_district || address.county || '';
                                const suburb = address.suburb || address.neighbourhood || address.village || '';
                                const road = address.road || '';
                                const house_number = address.house_number || '';

                                let detailed_address_parts = [];
                                
                                if (city) detailed_address_parts.push(city);
                                if (city_district && city_district !== city) detailed_address_parts.push(city_district);
                                if (suburb && suburb !== city_district) detailed_address_parts.push(suburb);

                                let road_part = road;
                                if (house_number) road_part += ` ${house_number}`;
                                if (road_part) detailed_address_parts.push(road_part.trim());

                                if (detailed_address_parts.length > 0) {
                                    fullAddress = detailed_address_parts.join(' ');
                                    locationName = fullAddress; 
                                    
                                    const parts = data.display_name.split(', ');
                                    const primaryName = parts.length > 0 ? parts[0] : null; 
                                    
                                    if (primaryName && !primaryName.includes(city) && !primaryName.includes(road)) {
                                        locationName = primaryName;
                                    }
                                } else {
                                    fullAddress = data.display_name;
                                    locationName = data.display_name.split(', ').slice(0, 2).join(', ');
                                }
                            } catch (error) {
                                console.error("Reverse geocoding error (Nominatim API):", error);
                            }
                            
                            currentLocationData = {
                                name: locationName,
                                address: fullAddress, 
                                lat: lat,
                                lon: lon
                            };
                            
                            saveButton.textContent = '위치 저장';
                            saveButton.disabled = false;
                        },
                        (error) => {
                            // GPS 실패 처리
                            console.error(`Geolocation error: ${error.code} - ${error.message}`);
                            showCustomToast('GPS 현재 위치를 찾을 수 없습니다. (권한 거부 또는 오류)');
                            saveButton.textContent = '위치 저장';
                            saveButton.disabled = false;
                        },
                        {
                            enableHighAccuracy: true, 
                            maximumAge: 30000, 
                            timeout: 10000 
                        }
                    );
                } else {
                    showCustomToast('이 브라우저는 GPS Geolocation 기능을 지원하지 않습니다.');
                    saveButton.textContent = '위치 저장';
                    saveButton.disabled = false;
                }
            }

            function searchPlaces() {
                const keyword = document.getElementById('address-input').value;
                if (!keyword.trim()) {
                    showCustomToast('키워드를 입력해주세요.');
                    return;
                }

                const ps = new kakao.maps.services.Places();
                ps.keywordSearch(keyword, (data, status) => {
                    if (status === kakao.maps.services.Status.OK) {
                        const firstPlace = data[0];
                        const coords = new kakao.maps.LatLng(firstPlace.y, firstPlace.x);
                        
                        map.setCenter(coords);
                        marker.setPosition(coords);
                        
                        currentLocationData = {
                            name: firstPlace.place_name,
                            address: firstPlace.road_address_name || firstPlace.address_name,
                            lat: firstPlace.y,
                            lon: firstPlace.x
                        };
                        
                    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                        showCustomToast('검색 결과가 존재하지 않습니다.');
                        currentLocationData = null;
                    } else {
                        showCustomToast('검색 중 오류가 발생했습니다.');
                        currentLocationData = null;
                    }
                });
            }

            document.getElementById('save-location-btn').addEventListener('click', () => {
                if (currentLocationData) {
                    localStorage.setItem('savedBapickLocation', JSON.stringify(currentLocationData));
                    showCustomToast(`'${currentLocationData.name}' 위치가 저장되었습니다!`);
                    
                    // returnTo 쿼리 파라미터 확인 후 이동 경로 설정
                    const urlParams = new URLSearchParams(window.location.search);
                    const returnTo = urlParams.get('returnTo');
                    const menu = urlParams.get('menu');
                    
                    if (returnTo === 'chat' && menu) {
                        // 채팅 화면으로 이동
                        window.location.href = `chat.html?returnTo=chat&menu=${menu}`; 
                    } else {
                        // 기존 로직 (홈 화면으로 이동)
                        window.location.href = 'home.html';
                    }
                } else {
                    showCustomToast('위치를 검색하거나, GPS 버튼을 눌러 위치를 설정해주세요.');
                }
            });

            document.getElementById('search-btn').addEventListener('click', searchPlaces);
            document.getElementById('address-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    searchPlaces();
                }
            });

            document.getElementById('gps-btn').addEventListener('click', setCurrentLocation);

            initMapWithGPS();
        });
    </script>
</body>
</html>