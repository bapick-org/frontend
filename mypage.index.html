<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow-x: hidden;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-bottom: 80px; /* Pastki menyu uchun joy */
        }
        .popup-hidden {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            transition: all 0.2s ease-out;
            pointer-events: none;
        }
        .popup-visible {
            opacity: 1;
            transform: scale(1) translateY(0);
            transition: all 0.2s ease-in;
            pointer-events: auto;
        }
    </style>
</head>
<body class="bg-white">
    
    <div id="custom-toast"
        class="fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-20 z-40 hidden transition-opacity duration-300"></div>

    <div class="h-full flex flex-col">
        
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200 flex-shrink-0">
            <div></div>
            <h1 class="text-xl font-bold text-center text-gray-800">마이페이지</h1>
            <div class="justify-self-end"></div>
        </header>

        <main class="flex-1 overflow-y-auto bg-gray-50">
            <div class="w-full">
                <section class="bg-white flex items-center p-5 border-b-8 border-gray-100">
                    <div class="w-16 h-16 rounded-full mr-4 flex-shrink-0 overflow-hidden bg-gray-200">
                        <img id="user-display-profile-image" class="w-full h-full object-cover" src="https://bapick-s3-bucket.s3.ap-northeast-2.amazonaws.com/default/default_profile.png" alt="프로필 사진">
                    </div>
                    <div class="flex-1">
                        <a href="profile_edit.html" class="text-lg font-bold text-gray-800 flex items-center">
                            <span id="user-display-name"></span>
                            <svg class="w-5 h-5 ml-1 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </a>
                    </div>
                </section>
                
                <section class="bg-white mt-2 p-5">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">설정</h2>
                    <ul class="divide-y divide-gray-100">
                        <li class="py-1"><a href="editinformation.index.html" class="flex justify-between items-center py-3.5 text-gray-700 hover:bg-gray-50 rounded-lg -mx-2 px-2"><span class="font-medium">회원정보 수정</span><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></li>
                        <li class="py-1"><a href="permission.index.html" class="flex justify-between items-center py-3.5 text-gray-700 hover:bg-gray-50 rounded-lg -mx-2 px-2"><span class="font-medium">권한 설정</span><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></li>
                        <li class="py-1"><a href="notification.index.html" class="flex justify-between items-center py-3.5 text-gray-700 hover:bg-gray-50 rounded-lg -mx-2 px-2"><span class="font-medium">알림 설정</span><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></li>
                        <li class="py-1"><a href="friend_list.html" class="flex justify-between items-center py-3.5 text-gray-700 hover:bg-gray-50 rounded-lg -mx-2 px-2"><span class="font-medium">친구 목록</span><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></li>
                        <li class="py-1"><a href="announcement.index.html" class="flex justify-between items-center py-3.5 text-gray-700 hover:bg-gray-50 rounded-lg -mx-2 px-2"><span class="font-medium">공지사항</span><svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></a></li>
                        <li class="py-1">
                            <a href="#" id="logout-btn" class="flex justify-between items-center py-3.5 text-red-500 hover:bg-red-50 rounded-lg -mx-2 px-2">
                                <span class="font-medium">로그아웃</span>
                                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </a>
                        </li>
                    </ul>
                </section>
            </div>
        </main>
    </div>

    <div id="logout-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-8 text-center flex flex-col items-center">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-5">
                <svg class="w-8 h-8 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" />
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-6">로그아웃 하시겠어요?</h2>
            <div class="w-full flex flex-col space-y-3">
                <button id="confirm-logout-btn" class="w-full py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800 transition-colors">로그아웃</button>
                <button id="cancel-logout-btn" class="w-full py-3 text-gray-600 font-medium rounded-lg hover:bg-gray-100 transition-colors">취소</button>
            </div>
        </div>
    </div>

    <div id="add-chat-popup" class="absolute bottom-24 left-1/2 -translate-x-1/2 w-48 bg-white rounded-md shadow-xl z-50 popup-hidden">
        <div class="py-2">
            <a href="chat_list.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                채팅 목록
            </a>
            <a href="chat.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                1:1 채팅방
            </a>
            <a href="chat_group.html" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><path d="M18 21v-2a4 4 0 0 0-4-4h-1"/><circle cx="9" cy="7" r="4"/><path d="M18 7h3a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-3"/><path d="m15.5 13.5-3-3 3-3"/></svg>
                단체 채팅방
            </a>
        </div>
    </div>
    
    <footer class="fixed bottom-0 left-0 right-0 z-30">
        <nav class="flex justify-around items-center h-16 bg-white rounded-t-2xl shadow-[0_-2px_10px_rgba(0,0,0,0.05)] max-w-screen-xl mx-auto">
            <a href="home.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                <span class="mt-1">홈</span>
            </a>
            <a href="calender.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span class="mt-1">캘린더</span>
            </a>
            <div class="w-1/5"></div>
            <a href="scrap.index.html" class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                <span class="mt-1">스크랩</span>
            </a>
            <a href="#" class="flex flex-col items-center justify-center w-1/5 h-full text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span class="font-bold mt-1">마이</span>
            </a>
        </nav>
    </footer>

    <button id="add-chat-btn" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#FF7242] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg z-40">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
    </button>
    
    <script type="module">
        // Firebase SDK import 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";
        
        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const fastapiUrl = "https://bapick.duckdns.org"
        
        // DOM 요소 로드
        const overlay = document.getElementById('overlay');
        const logoutBtn = document.getElementById('logout-btn');
        const logoutModal = document.getElementById('logout-modal');
        const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
        const confirmLogoutBtn = document.getElementById('confirm-logout-btn');
        const addChatBtn = document.getElementById('add-chat-btn');
        const addChatPopup = document.getElementById('add-chat-popup');
        const userDisplayName = document.getElementById('user-display-name');
        const userDisplayProfileImage = document.getElementById('user-display-profile-image');

        // ✅ [추가] 커스텀 토스트 관련 변수 및 함수 정의
        const customToast = document.getElementById('custom-toast');
        const toastDuration = 2500; 

        function showCustomToast(message) {
            if (!customToast) return;
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

            setTimeout(() => {
                customToast.classList.remove('opacity-100');
                customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }
        
        // 팝업/모달 관리 함수
        function closeAllPopups() {
            overlay.classList.add('hidden');
            addChatPopup.classList.remove('popup-visible');
            addChatPopup.classList.add('popup-hidden');
            logoutModal.classList.add('hidden');
            // withdrawalModal.classList.add('hidden'); // 존재하지 않는 변수 제거
        }

        // (1) 유저 정보를 로드하는 비동기 함수
        async function loadUserProfile(user) {
            if (!user) {
                userDisplayName.textContent = "로그인이 필요합니다";
                return;
            }

            try {
                const idToken = await user.getIdToken();

                const fields = ['nickname', 'profileImage'];
                const res = await fetch(`${fastapiUrl}/api/users/me?fields=${fields.join(',')}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const data = await res.json();

                // UI 업데이트
                userDisplayName.textContent = `${data.nickname}님`;
                userDisplayProfileImage.src = data.profileImage;

            } catch (err) {
                console.error('마이페이지 유저 정보 로드 실패:', err);
                userDisplayName.textContent = '정보를 불러오지 못했습니다';
            }
        }

        // =======================================================
        // 이벤트 리스너
        // =======================================================
        
        // ✅ [수정] 채팅 추가 버튼 클릭 시 (팝업 토글)
        addChatBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isAddChatOpen = addChatPopup.classList.contains('popup-visible');
            closeAllPopups();
            if (!isAddChatOpen) {
                overlay.classList.remove('hidden');
                addChatPopup.classList.remove('popup-hidden');
                addChatPopup.classList.add('popup-visible');
            }
        });
        
        overlay.addEventListener('click', closeAllPopups);
        
        // ✅ [수정] 로그아웃 확인 버튼 클릭 시 (alert -> 토스트)
        confirmLogoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                // 로그아웃 성공 후 로그인 페이지로 이동
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('로그아웃 에러:', error);
                showCustomToast('로그아웃에 실패했습니다.'); // ✅ [수정] alert -> 토스트
            });
        });
        
        // 로그아웃 버튼 클릭 시 모달 열기
        logoutBtn.addEventListener('click', (e) => { 
            e.preventDefault(); 
            closeAllPopups(); // 다른 팝업 닫고
            logoutModal.classList.remove('hidden'); 
            overlay.classList.remove('hidden'); 
        });
        
        // 로그아웃 모달 취소 버튼
        cancelLogoutBtn.addEventListener('click', () => { 
            logoutModal.classList.add('hidden'); 
            overlay.classList.add('hidden'); 
        });

        // Firebase 인증 상태 확인
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                // 로그인되지 않은 경우, 바로 loadUserProfile(user)를 호출하여 "로그인이 필요합니다"를 표시
                // 리다이렉션은 수동으로 하지 않습니다.
            }
            loadUserProfile(user); 
        });
    </script>
</body>
</html>