<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>친구 목록 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <header class="p-4 border-b border-gray-200 flex-shrink-0 bg-white">
        <div class="flex items-center">
            <a href="/mypage/index" class="text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 19l-7-7 7-7" />
                </svg>
            </a>
            <h1 class="text-xl font-bold text-gray-800 text-center flex-1 pr-6">친구 목록</h1>
        </div>
    </header>

    <section class="px-4 py-6">
        <div class="flex items-center bg-gray-100 rounded-lg overflow-hidden transition-all duration-200 
                    focus-within:ring-1 focus-within:ring-[#ff7242] focus-within:border-[#ff7242]">
            
            <input type="text" id="search-input" placeholder="닉네임으로 친구를 검색하세요" 
                    class="flex-1 p-3 bg-gray-100 text-gray-700 focus:outline-none">
            
            <button id="clear-search" class="hidden p-2 text-gray-400 hover:text-gray-600 focus:outline-none">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>

            <button id="search-button" class="p-3 text-gray-500 transition-all duration-200
                    hover:text-[#ff7242] focus:outline-none focus:text-[#ff7242]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" 
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" /><line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
            </button>
        </div>
    </section>

    <main class="flex-1 px-4 overflow-y-auto">
        <h2 id="list-title" class="text-lg font-semibold text-gray-600 uppercase">내 친구 목록</h2>
        <div id="main-container">
            <p class="text-center text-gray-500 mt-10">목록을 불러오는 중...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

        let idToken = null;

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const clearSearchBtn = document.getElementById('clear-search');
        const mainContainer = document.getElementById('main-container');
        const listTitle = document.getElementById('list-title');


        function getKoreanInitial(name) {
            if (name === undefined || name.length === 0) return '#';
            const code = name.charCodeAt(0) - 44032;
            if (code < 0 || code > 11172) return '#';
            const initial = Math.floor(code / 588);
            const initialConsonants = [
                'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ',
                'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
            ];
            return initialConsonants[initial];
        }

        async function getFriendList() {
            try {
                const response = await fetch(`${API_URL}/api/friends`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || `친구 목록을 불러오던 중 오류가 발생했습니다.`);
                }

                const result = await response.json();
                renderFriendListByInitial(result.data || []);
                updateUIState(false);
            } catch (error) {
                if (isLocal) console.error("[친구 목록 조회 실패]:", error);
                mainContainer.innerHTML = `<p class="text-center text-red-500 mt-10">친구 목록을 불러오던 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }

        async function searchFriend(query) {
            if (!idToken) return [];

            updateUIState(true, query);
            mainContainer.innerHTML = `<p class="text-center text-[#ff7242] mt-10">검색 중...</p>`;

            try {
                const encodedQuery = encodeURIComponent(query.trim());
                const response = await fetch(`${API_URL}/api/friends?keyword=${encodedQuery}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || `친구 검색 중 오류가 발생했습니다.`);
                }

                const result = await response.json();
                renderSearchResults(result.data || []);
            } catch (error) {
                if (isLocal) console.error("[친구 검색 실패]:", error);
                mainContainer.innerHTML = `<p class="text-center text-red-500 mt-4">친구 검색 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</p>`;
            }
        }

        async function deleteFriend(targetUid) {
            if (!idToken) return false;

            if (!confirm('정말로 이 친구를 삭제하시겠습니까?')) {
                return false;
            }

            try {
                const response = await fetch(`${API_URL}/api/friends/${targetUid}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (response.status === 204) {
                    alert("친구가 삭제되었습니다.");
                    return true;
                }

                if (response.status === 404) {
                    // 이미 삭제된 상태 → 멱등성 보장
                    if (isLocal) console.warn("이미 존재하지 않는 친구 관계 삭제 요청");
                    alert("친구가 삭제되었습니다.");
                    return true;
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || "친구 삭제 중 오류가 발생했습니다.");
                }
            } catch (error) {
                if (isLocal) console.error("[친구 삭제 실패]:", error);
                alert(`친구 삭제 중 오류가 발생했습니다.`);
                return false;
            }
        }

        // =========================================================
        // 2. UI 로직: 초성별 친구 목록 렌더링
        // =========================================================

        function renderFriendListByInitial(friends) {
            mainContainer.innerHTML = '';
            if (friends.length === 0) {
                mainContainer.innerHTML = `<p class="text-center text-gray-500 mt-10">등록된 친구가 없습니다.</p>`;
                return;
            }

            // 1. 친구 목록을 초성별로 그룹화
            const groupedFriends = friends.reduce((groups, friend) => {
                const initial = getKoreanInitial(friend.nickname ? friend.nickname.charAt(0) : '#');
                if (!groups[initial]) {
                    groups[initial] = [];
                }
                groups[initial].push(friend);
                return groups;
            }, {});

            // 2. 초성 키를 정렬 (ㄱㄴㄷ 순)
            const sortedInitials = Object.keys(groupedFriends).sort((a, b) => {
                if (a === '#') return 1;
                if (b === '#') return -1;
                return a.localeCompare(b);
            });

            // 3. 그룹별로 렌더링
            sortedInitials.forEach(initial => {
                const initialHeader = document.createElement('h3');
                initialHeader.className = 'sticky top-0 text-[#ff7242] font-bold text-base py-1 border-b border-gray-200 mt-2';
                initialHeader.textContent = initial;
                mainContainer.appendChild(initialHeader);

                groupedFriends[initial].forEach(friend => {
                    const friendCard = createFriendCard(friend, 'friend');
                    mainContainer.appendChild(friendCard);
                });
            });
        }

        // 검색 결과 렌더링 함수
        function renderSearchResults(users) {
            mainContainer.innerHTML = '';

            if (users.length === 0) {
                mainContainer.innerHTML = `<p class="text-center text-gray-500 mt-4">검색 결과가 없습니다.</p>`;
                return;
            }

            users.forEach(user => {
                const userCard = createFriendCard(user);
                mainContainer.appendChild(userCard);
            });
        }

        // =========================================================
        // 5. 공통 UI 컴포넌트: 친구 카드 생성
        // =========================================================
        function createFriendCard(user) {
            const card = document.createElement('div');
            card.className = 'flex items-center justify-between px-3 py-5 rounded-lg hover:bg-gray-100 transition-colors';

            const profileImageUrl = user.profileImage && user.profileImage.trim() !== ''
                ? user.profileImage
                : '/assets/images/default-profile.jpg';

            card.innerHTML = `
                <div class="flex items-center space-x-3">
                    <img class="h-12 w-12 rounded-full object-cover" src="${profileImageUrl}" alt="${user.nickname}님의 프로필 사진">
                    <span class="ml-4 font-medium text-gray-800">${user.nickname || '이름 없음'}</span>
                </div>
                <div class="flex-shrink-0">
                    <button data-target-uid="${user.firebaseUid}" class="delete-friend-btn text-sm text-white bg-orange-500 hover:bg-orange-600 px-4 py-2 rounded-md">
                        친구 삭제
                    </button>
                </div>
            `;
            return card;
        }

        // =========================================================
        // 6. 이벤트 리스너
        // =========================================================
        
        // 검색 상태에 따라 ui 상태 업데이트
        function updateUIState(isSearch, query = "") {
            if (isSearch) {
                listTitle.textContent = `"${query}" 검색 결과`;
                clearSearchBtn.classList.remove('hidden');
            } else {
                listTitle.textContent = "내 친구 목록";
                clearSearchBtn.classList.add('hidden');
                searchInput.value = "";
            }
        }

        clearSearchBtn.addEventListener('click', getFriendList);

        // 검색 버튼 이벤트
        searchButton.addEventListener('click', () => {
            const query = searchInput.value.trim();
            query ? searchFriend(query) : getFriendList();
        });

        // 실시간 X 버튼 표시 제어
        searchInput.addEventListener('input', (e) => {
            if (e.target.value) clearSearchBtn.classList.remove('hidden');
            else if (listTitle.textContent === "내 친구 목록") clearSearchBtn.classList.add('hidden');
        });

        // 엔터 키 입력 시 검색 이벤트
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchButton.click();
            }
        });

        // 친구 삭제 버튼 클릭 이벤트 위임
        document.addEventListener('click', async (e) => {
            const deleteBtn = e.target.closest('.delete-friend-btn');
            if (!deleteBtn) return;

            const targetUid = deleteBtn.dataset.targetUid;
            const success = await deleteFriend(targetUid);

            if (success) {
                await getFriendList();
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('로그인이 필요합니다.');
                window.location.href = '/index';
                return;
            }
            idToken = await user.getIdToken();
            getFriendList(user);
        });
    </script>
</body>

</html>