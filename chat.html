<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>ì±„íŒ… - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=94e1cbafcab8cb15123fc074cee3dec2&libraries=services,places"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        html {
            height: 100%; 
        }
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .chat-container {
            width: 100%;
            height: 100%;
            display: flex; 
            flex-direction: column;
            background-color: #fff;
            box-shadow: none;
            border-radius: 0;
            overflow: hidden;
        }
        .header {
            background-color: #fff;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .header h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #333;
        }
        .chat-area {
            flex-grow: 1; 
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem; 
        }
        .message-box {
            display: flex;
        }
        .message-box.system-message {
            justify-content: flex-start;
            align-items: flex-end;
        }
        .message-box.user-message {
            justify-content: flex-end;
        }
        .profile-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: #6b7280;
            flex-shrink: 0;
            margin-right: 0.75rem;
        }
        .profile-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            line-height: 1.4;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);            
            word-break: break-word;
            overflow-wrap: break-word;
        }
        .message-bubble.system-bubble {
            background-color: #e5e7eb;
            color: #333;
            border-bottom-left-radius: 0.25rem;
            min-height: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center; 
        }
        .message-bubble.user-bubble {
            background-color: #FF7242;
            color: #fff;
            border-bottom-right-radius: 0.25rem;
        }
        .input-area {
            background-color: #fff;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        .input-container {
            position: relative;
            flex-grow: 1;
        }
        .input-area input {
            width: 100%;
            padding: 0.75rem 1.25rem;
            padding-right: 3rem;
            border-radius: 2rem;
            background-color: #f0f2f5;
            border: none;
            outline: none;
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .icon-button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* ì‹ë‹¹ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .restaurant-cards-container {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            max-width: 100%;
        }
        .restaurant-card {
            width: 240px;
            flex-shrink: 0;
            background-color: #e5e7eb;
            border-radius: 1.25rem;
            text-decoration: none;
        }
        .send-button {
            position: absolute;
            right: 0.25rem;
            top: 50%;
            transform: translateY(-50%);
            background-color: #d1d5db;
            color: #fff;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .send-button.active {
            background-color: #FF7242;
            box-shadow: 0 4px 8px rgba(255, 114, 66, 0.4);
        }
        .send-button .arrow-up {
            transform: rotate(0deg);
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        .typing-indicator span {
            width: 6px;
            height: 6px;
            background-color: #999;
            border-radius: 50%;
            display: inline-block;
            animation: blink 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0% { opacity: 0.3; transform: translateY(0); }
            20% { opacity: 1; transform: translateY(-2px); }
            40% { opacity: 0.3; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <header class="header">
            <button class="text-gray-500 hover:text-gray-700" onclick="window.location.href='chat_list.html'">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="headerTitle">ë°¥í’€ì´</h1>
            <div style="width: 24px; height: 24px;"></div>
        </header>

        <main class="chat-area"></main> 

        <div class="input-area">            
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onclick="this.focus()">
                <button id="sendButton" class="send-button">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 arrow-up" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <script type="module">
    // Firebase SDK import 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { firebaseConfig } from "./firebase-config.js";

    // Firebase ì•± ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    const API_URL = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

    // JSON ì‘ë‹µ 
    marked.setOptions({ breaks: true, gfm: true});

    // ì „ì—­ ë³€ìˆ˜
    let idToken = null;
    let currentUserUid = null;
    let currentRoomId = null;
    let isCreatingRoom = false;
    let currentChatroomIsGroup = false;
    let websocket = null;
    let isWebSocketConnected = false;
    // í ê´€ë ¨ ë³€ìˆ˜
    let messageQueue = []; // ë°©ì´ ìƒê¸°ê¸° ì „ ë³´ë‚¸ ë©”ì‹œì§€ë“¤ì„ ë‹´ì•„ë‘ëŠ” í
    let isRoomReady = false; // ë°© ìƒì„± ì™„ë£Œ ì—¬ë¶€
    let isProcessingQueue = false; // í ì²˜ë¦¬ ì¤‘ì¸ì§€ ì—¬ë¶€

    // DOM ìš”ì†Œ
    const sendButton = document.getElementById('sendButton');
    const messageInput = document.getElementById('messageInput');
    const chatArea = document.querySelector('.chat-area');
    const headerTitle = document.getElementById('headerTitle');


    /* =========================================================
    * ìœ í‹¸ í•¨ìˆ˜
    * ======================================================= */
    // URLì—ì„œ roomIdë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function getRoomIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('roomId'); 
    }

    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ë‚´ë¦¬ëŠ” í•¨ìˆ˜
    function scrollToBottom(element) {
        if (!element) return;
        
        // ë¸Œë¼ìš°ì €ê°€ ë‹¤ìŒ í™”ë©´ì„ ê·¸ë¦¬ê¸° ì§ì „ì— ì‹¤í–‰í•˜ë„ë¡ ì˜ˆì•½
        requestAnimationFrame(() => {
            element.scrollTop = element.scrollHeight;
            
            // ë§Œì•½ ì´ë¯¸ì§€ê°€ ë§ë‹¤ë©´ í•œ ë²ˆ ë” ì‹œë„ (ì•ˆì „ì¥ì¹˜)
            setTimeout(() => {
                element.scrollTop = element.scrollHeight;
            }, 50);
        });
    }

    // ì±„íŒ…ë°© ì…ì¥ ì¦‰ì‹œ í•˜ë“œì½”ë”©ëœ ì¸ì‚¬ ë©”ì‹œì§€ë¥¼ ë³´ì—¬ì¤Œ (ì†ë„ ìµœì í™”)
    function showHeadlineMessage() {
        chatArea.innerHTML = ''; // í™”ë©´ ì´ˆê¸°í™”
        const headline = {
            role: 'assistant',
            content: "ì•ˆë…•! ë‚˜ëŠ” ì˜¤ëŠ˜ì˜ ìš´ì„¸ì— ë§ì¶° í–‰ìš´ì˜ ë§›ì§‘ì„ ì¶”ì²œí•´ì£¼ëŠ” 'ë°¥í’€ì´'ì•¼ğŸ€ ì§€ê¸ˆ ë„ˆí•œí…Œ ë”± ë§ëŠ” ë©”ë‰´ ì¶”ì²œí•´ì¤„ê¹Œ? ë¨¹ê³  ì‹¶ì€ ë©”ë‰´ ê³ ë¥´ë©´ ì‹ë‹¹ë„ ì•Œë ¤ì¤„ê²Œ!"
        };
        chatArea.appendChild(createTextMessage(headline));
        scrollToBottom(chatArea);
    }

    // API í†µì‹  ì‹¤íŒ¨ ë° ì—ëŸ¬ UI ì²˜ë¦¬
    function handleApiError(error, loadingDiv, container, defaultMsg) {
        if (loadingDiv && loadingDiv.parentNode) {
            loadingDiv.parentNode.removeChild(loadingDiv);
        }
        console.error("API ì˜¤ë¥˜:", error);
        const errorMsg = { role: 'assistant', content: `${defaultMsg}: ${error.message || error}` };
        container.appendChild(createTextMessage(errorMsg));
        scrollToBottom(container);
    }

    // Loading Indicator ì œê±°
    function removeLoadingIndicator() {
        const loadingDivs = document.querySelectorAll('.typing-indicator');
        loadingDivs.forEach(div => {
            const messageBox = div.closest('.message-box');
            if (messageBox && messageBox.parentNode) {
                messageBox.parentNode.removeChild(messageBox);
            }
        });
    }

    /* =========================================================
    * DOM ìƒì„± ë° ë Œë”ë§ í•¨ìˆ˜
    * ======================================================= */
    // Loading Indicator ìƒì„± ë° ë Œë”ë§
    function renderLoadingIndicator() {
        const botLoadingDiv = document.createElement("div");
        botLoadingDiv.className = "message-box system-message";

        botLoadingDiv.innerHTML = `
            <div class="profile-icon">
                <img class="rounded-full object-cover" src="/assets/images/logo-bg-orange.png" alt="Profile">
            </div>
            <div class="message-bubble system-bubble">
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;

        chatArea.appendChild(botLoadingDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
        return botLoadingDiv;
    }
    

    // í”„ë¡œí•„ ì´ë¯¸ì§€ ìƒì„± (ì±—ë´‡/ë‹¤ë¥¸ ì‚¬ìš©ì)
    function createProfileIcon(msg, isAssistant) {
        const div = document.createElement('div');
        div.className = 'profile-icon';

        const img = document.createElement('img');
        img.className = 'rounded-full object-cover';
        img.alt = isAssistant ? 'Profile' : `${msg.senderName} í”„ë¡œí•„`;
        img.src = isAssistant ? '/assets/images/logo-bg-orange.png' : (msg.senderProfileUrl || '/assets/images/default-profile.jpg');

        div.appendChild(img);
        return div;
    }
    
    // ì¼ë°˜ ë©”ì‹œì§€(í…ìŠ¤íŠ¸) ìƒì„± (ì±—ë´‡/ë³¸ì¸/ë‹¤ë¥¸ ì‚¬ìš©ì)
    function createTextMessage(msg) {
        const messageBox = document.createElement('div');
        const isAssistant = (msg.role === 'assistant');

        // senderIdë¡œ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€ì¸ì§€ íŒë‹¨
        const isMyMessage = msg.senderId === currentUserUid && !isAssistant;
        messageBox.className = `message-box ${isMyMessage ? 'user-message' : 'system-message'}`; 

        let bubbleContent;
        const contentHtml = marked.parse(msg.content);

        if (isAssistant) {
            // ì–´ì‹œìŠ¤í„´íŠ¸(ì±—ë´‡) ë©”ì‹œì§€
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble system-bubble';
            bubbleDiv.innerHTML = contentHtml;

            messageBox.appendChild(createProfileIcon(msg, true));
            messageBox.appendChild(bubbleDiv);

        } else if (isMyMessage) {
            // ë³¸ì¸ ë©”ì‹œì§€
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble user-bubble';
            bubbleDiv.innerHTML = contentHtml;

            messageBox.appendChild(bubbleDiv);

        } else {
            // ë‹¤ë¥¸ ì‚¬ìš©ì ë©”ì‹œì§€
            const senderName = msg.senderName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble system-bubble';
            bubbleDiv.innerHTML = `<div class="text-xs text-gray-600 mb-1">${senderName}</div>${contentHtml}`;

            messageBox.appendChild(createProfileIcon(msg, false));
            messageBox.appendChild(bubbleDiv);
        }

        return messageBox;
    }

    // ì£¼ì†Œ ì„¤ì • ë²„íŠ¼ ìƒì„± (í˜„ì¬ ìœ„ì¹˜/ì €ì¥ëœ ìœ„ì¹˜)
    function createLocationButtons(msg) {
        // ì €ì¥ëœ ìœ„ì¹˜ ì •ë³´ í™•ì¸ ë° íŒŒì‹±
        const savedLocationRaw = localStorage.getItem('savedBapickLocation');
        let savedLocation = null; // ì €ì¥ëœ ìœ„ì¹˜ ê°ì²´ (null ë˜ëŠ” íŒŒì‹±ëœ JSON)
        let savedLocationText = 'ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš©';
        let hasSavedLocation = false; // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€
        
        if (savedLocationRaw) {
            try {
                // savedLocationì— í• ë‹¹ (ìŠ¤ì½”í”„ ë¬¸ì œ í•´ê²°)
                savedLocation = JSON.parse(savedLocationRaw); 
                
                // ìœ íš¨ì„± ê²€ì‚¬ (lat, lon í•„ë“œ í™•ì¸)
                if (savedLocation && savedLocation.lat && savedLocation.lon) { 
                    // ë²„íŠ¼ì— í‘œì‹œí•  í…ìŠ¤íŠ¸
                    const displayAddress = savedLocation.name || savedLocation.address || 'ì €ì¥ëœ ìœ„ì¹˜';
                    savedLocationText = `${displayAddress}`;
                    hasSavedLocation = true;
                }
            } catch (e) {
                console.error("Error parsing savedBapickLocation:", e);
                savedLocation = null; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê°ì²´ë¥¼ nullë¡œ ìœ ì§€
            }
        }

        const container = document.createElement('div');
        container.className = 'location-buttons flex flex-row flex-wrap gap-2 mt-2 w-full';
        const locationBtnBase = 'location-select-button px-3 py-2 rounded-xl text-sm font-medium border transition';
        
        // í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© ë²„íŠ¼
        const currentBtn = document.createElement('button');
        currentBtn.textContent = 'í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© (GPS)';
        currentBtn.className = `${locationBtnBase} bg-[#FF7242] text-white hover:bg-[#E85F33]`;
        currentBtn.setAttribute('data-action', 'CURRENT_LOCATION');

        container.appendChild(currentBtn);

        // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© ë²„íŠ¼ (ë¡œì»¬ìŠ¤íŠ¸ë¡œì§€ì— ì €ì¥ëœ ìœ„ì¹˜ê°€ ìˆì„ ê²½ìš°ì—ë§Œ ìƒì„±)
        if (hasSavedLocation) { 
            const savedBtn = document.createElement('button');
            savedBtn.textContent = savedLocationText;
            savedBtn.className   = `${locationBtnBase} bg-indigo-500 text-white hover:bg-indigo-600`;
            savedBtn.setAttribute('data-action', 'SAVED_LOCATION');
            savedBtn.setAttribute('data-lat', savedLocation.lat);
            savedBtn.setAttribute('data-lon', savedLocation.lon);
            
            container.appendChild(savedBtn); 
        }

        return container;
    }

    // ë‹¨ì¼ ì‹ë‹¹ ì¹´ë“œ ìƒì„±
    function createRestaurantCard(restaurant, index) {        
        let imageUrl = '/assets/images/logo-bg-orange.png'; // ê¸°ë³¸ ì´ë¯¸ì§€
        
        if (restaurant.image) {
            imageUrl = restaurant.image;
        }
        
        // ì‚¬ìš©ìê°€ ì„ íƒí•œ ì£¼ì†Œì™€ ì‹ë‹¹ ê°„ ê±°ë¦¬ ì •ë³´
        let distanceText = '';
        if (restaurant.distance_m !== undefined) {
            if (restaurant.distance_m < 1000) {
                // 1km ë¯¸ë§Œ: m ë‹¨ìœ„
                distanceText = `${restaurant.distance_m}m`;
            } else {
                // 1km ì´ìƒ: km ë‹¨ìœ„ (ì†Œìˆ˜ì  1ìë¦¬)
                distanceText = `${restaurant.distance_km}km`;
            }
        }

        return `
            <a href="detail.html?id=${restaurant.id}" class="restaurant-card overflow-hidden">
                <img
                    src="${imageUrl}" 
                    alt="${restaurant.name} ì´ë¯¸ì§€" 
                    class="w-full h-32 object-cover rounded-t-lg"
                    onerror="console.error('Image load failed:', this.src); this.src='/assets/images/logo-bg-orange.png';"
                >
                <div class="p-3">
                    <h3 class="font-bold text-lg text-gray-900 truncate">${index + 1}. ${restaurant.name}</h3>
                    <p class="text-sm text-gray-500 mb-1 truncate">${restaurant.category}</p>
                    <p class="text-sm text-gray-500 mb-1 truncate">${restaurant.address}</p>
                    ${distanceText ? `<p class="text-xs text-[#FF7242] font-semibold mb-1"> ${distanceText}</p>` : ''}
                </div>
            </a>
        `;
    }

    // ì—¬ëŸ¬ ì‹ë‹¹ ì¹´ë“œ ì¶”ê°€
    function appendRestaurantcards(replyMessage, container) {
        try {
            const cardData = JSON.parse(replyMessage.content);

             // restaurant ë°°ì—´ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ ìƒì„±í•˜ì§€ ì•Šê³  ë¦¬í„´
            if (!cardData.restaurants || cardData.restaurants.length === 0) {
                return;
            }

            const cardsContainer = document.createElement('div');
            cardsContainer.className = `message-box ${replyMessage.role === 'assistant' ? 'system-message' : 'user-message'}`; 
            
            const cardsContentWrapper = document.createElement('div');
            cardsContentWrapper.className = 'restaurant-cards-container flex flex-row space-x-4 overflow-x-auto';

            cardData.restaurants.forEach((restaurant, index) => {
                const cardHtml = createRestaurantCard(restaurant, index); 
                cardsContentWrapper.insertAdjacentHTML('beforeend', cardHtml);
            });

            if (replyMessage.role === 'assistant') {
                cardsContainer.appendChild(createProfileIcon(replyMessage, true));
            }

            cardsContainer.appendChild(cardsContentWrapper);
            container.appendChild(cardsContainer);
            
        } catch (e) {
            console.error("Card JSON íŒŒì‹± ë° ë Œë”ë§ ì˜¤ë¥˜:", e);
            console.error("Content that failed:", replyMessage.content);
            container.appendChild(createTextMessage(replyMessage)); 
        }
    }

    // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë Œë”ë§ ì²˜ë¦¬ (ì¼ë°˜ í…ìŠ¤íŠ¸/ì‹ë‹¹ ì¹´ë“œ/ìœ„ì¹˜ ì„¤ì •)
    function renderMessageByType(msg, chatArea) {
        const isCardMessage =
            msg.messageType  === 'restaurant_cards' ||
            (msg.role === 'assistant' && msg.content && msg.content.trim().startsWith('{"restaurants":'));

        if (msg.messageType === "hidden_initial") {
            return;
        }
                
        if (msg.messageType === 'location_select') {
            isExpectingAddress = true; 

            const messageBox = createTextMessage(msg);
            const bubbleDiv = messageBox.querySelector('.message-bubble');

            const buttonsDiv = createLocationButtons(msg);
            bubbleDiv.appendChild(buttonsDiv);

            chatArea.appendChild(messageBox);
        } else if (isCardMessage) {
            isExpectingAddress = false;
            appendRestaurantcards(msg, chatArea);
        } else {
            isExpectingAddress = false;
            chatArea.appendChild(createTextMessage(msg));
        }
    }

    // ë°©ì˜ íƒ€ì…(ê·¸ë£¹ì±„íŒ…/1:1)ì— ë”°ë¼ ì±„íŒ…ë°© ì œëª© ë° placeholder ì„¤ì •
    function setRoomTypeUI(data) {
        currentChatroomIsGroup = data.isGroup || false;
        let roomName;
            
        if (currentChatroomIsGroup) {
            messageInput.placeholder = "@ë°¥í’€ì´ë¥¼ ì…ë ¥í•˜ë©´ ë´‡ì´ ì‘ë‹µí•©ë‹ˆë‹¤";
            roomName = `ë‹¨ì²´ì±„íŒ…ë°©`;
        } else {
            messageInput.placeholder = "ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...";
            roomName = `ë°¥í’€ì´`;
        }

        headerTitle.textContent = data.chatroomName || roomName; 
    }

    /* =========================================================
    * WebSocket
    * ======================================================= */
    let WS_URL = null;
    
    async function loadConfig() {
        if (isLocal) {
            WS_URL = 'ws://127.0.0.1:8000';
            return;
        }
        
        try {
            const response = await fetch('/api/ws-config');
            const config = await response.json();
            WS_URL = config.wsUrl;
        } catch (error) {
            console.error('Failed to load WebSocket config, using fallback');
            WS_URL = 'wss://bapick.duckdns.org';
        }
    }

    // WebSocket ì—°ê²° ìƒì„± ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    async function connectWebSocket(roomId, token) {
        if (!WS_URL) await loadConfig();
        
        if (websocket) {
            websocket.close();
        }

        websocket = new WebSocket(`${WS_URL}/api/chatrooms/ws/${roomId}?token=${token}`);

        // WebSocket ì—°ê²° ì™„ë£Œë¥¼ Promiseë¡œ ê¸°ë‹¤ë¦¼
        return new Promise((resolve, reject) => {
            // íƒ€ì„ì•„ì›ƒ ì„¤ì •
            const timeout = setTimeout(() => {
                if (!isWebSocketConnected) {
                    reject(new Error('WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ'));
                }
            }, 10000); // 10ì´ˆ

            websocket.onopen = async () => {
                clearTimeout(timeout); // íƒ€ì„ì•„ì›ƒ í•´ì œ
                isWebSocketConnected = true;
                
                // ì—°ê²° ì™„ë£Œ í›„ í ì²˜ë¦¬
                if (messageQueue.length > 0 && isRoomReady) {
                    await processQueuedMessages();
                }
                
                resolve(); // ì—°ê²° ì™„ë£Œ ì‹ í˜¸
            };

            websocket.onmessage = (event) => {
                handleWebSocketMessage(event);
            };

            websocket.onerror = (error) => {
                console.error('WebSocket ì˜¤ë¥˜:', error);
            };

            websocket.onclose = () => {
                isWebSocketConnected = false;
            };
        });
    }

    // ìˆ˜ì‹ í•œ WebSocket ë©”ì‹œì§€ ìœ í˜•ë³„ ì²˜ë¦¬
    function handleWebSocketMessage(event) {
        try {
            const data = JSON.parse(event.data);
            
            if (data.type === 'new_message') {
                const msg = data.message;
                // ìˆ¨ê¹€ íƒ€ì… ë©”ì‹œì§€ëŠ” í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (msg.messageType === "hidden_initial") {
                    return;
                }
                
                // ìì‹ ì´ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì´ë¯¸ í™”ë©´ì— í‘œì‹œí–ˆìœ¼ë¯€ë¡œ ë¬´ì‹œ
                if (msg.senderId === currentUserUid && msg.role === 'user') {
                    return;
                }
                
                // ë¡œë”© UI ì œê±° (ë´‡ ì‘ë‹µì´ ì˜¤ë©´)
                if (msg.role === 'assistant') {
                    removeLoadingIndicator();
                }
                
                // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ë Œë”ë§
                renderMessageByType(msg, chatArea);

                scrollToBottom(chatArea);

            } else if (data.type === 'error') {
                console.error('ì„œë²„ ì—ëŸ¬:', data.message);
                
                removeLoadingIndicator();
                
                const errorMsg = { role: 'assistant', content: data.message };
                chatArea.appendChild(createTextMessage(errorMsg));
                scrollToBottom(chatArea);
            }
        } catch (err) {
            console.error('WebSocket ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', err);
        }
    }

    /* =========================================================
    * API ìš”ì²­
    * ======================================================= */
    // ì±„íŒ…ë°© ìƒì„± ë° ì´ˆê¸°í™”
    async function createChatRoom() {
        if (currentRoomId !== null || isCreatingRoom || !idToken) return;
        
        isCreatingRoom = true;

        try {
            const res = await fetch(`${API_URL}/api/chatrooms`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${idToken}`
                },
                body: JSON.stringify({
                    isGroup: false,
                    members: []
                })
            });

            if (!res.ok) {
                const errorData = await res.json();
                throw new Error(errorData.message || errorData.detail || `ì±„íŒ…ë°© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }

            const data = await res.json();
            const locationHeader = res.headers.get('Location');
            currentRoomId = locationHeader ? locationHeader.split('/').pop() : data.id;
            
            // ë°©ì˜ íƒ€ì…(ê·¸ë£¹/1:1)ì— ë”°ë¼ ì œëª©ê³¼ placeholder ì„¤ì •
            setRoomTypeUI(data);
            
            // WebSocket ì—°ê²°ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼
            await connectWebSocket(currentRoomId, idToken);
            isRoomReady = true; 

            // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ì²˜ë¦¬
            if (messageQueue.length > 0) {
                await processQueuedMessages();
            }

            return data;
        } catch (err) {
            if (isLocal) console.error("[ì±„íŒ…ë°© ìƒì„± ì‹¤íŒ¨]:", error);
            isRoomReady = false;
            messageQueue = []; // í ì‚­ì œ
            alert("ë°© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
        } finally {
            isCreatingRoom = false;
            sendButton.disabled = false;
            messageInput.disabled = false;
        }
    }
    
    // íì— ì €ì¥ëœ ë©”ì‹œì§€ ìˆœì°¨ ì²˜ë¦¬
    async function processQueuedMessages() {
        isProcessingQueue = true;  

        if (messageQueue.length === 0) return;
        
        // íë¥¼ ë³µì‚¬í•˜ê³  ì¦‰ì‹œ ì›ë³¸ì„ ë¹„ì›€ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)
        const messages = [...messageQueue];
        messageQueue = [];
        
        for (const queuedMessage of messages) {
            messageInput.value = queuedMessage;
            await sendMessage();
        }

        isProcessingQueue = false;
    }

    // ê¸°ì¡´ ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë¥¼ ë Œë”ë§
    async function loadMessages(roomId, container) {
        messageInput.disabled = true;

        try {
            const response = await fetch(`${API_URL}/api/chatrooms/${roomId}/messages`, {
                headers: { "Authorization": `Bearer ${idToken}` }
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || errorData.detail || `ì±„íŒ…ë°©ì˜ ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
            }

            const data = await response.json();

            setRoomTypeUI(data); // ë°©ì˜ íƒ€ì…(ê·¸ë£¹/1:1)ì— ë”°ë¼ ì œëª©, placeholder ì„¤ì •

            if (data && data.messages && data.messages.length > 0) {
                const newContent = document.createDocumentFragment();

                data.messages.forEach(msg => {
                    // llm ì „ìš© ë©”ì‹œì§€ëŠ” ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                    if (msg.messageType === 'hidden_initial') return;

                    // ìœ„ì¹˜ ì •ë³´ ë©”ì‹œì§€ë„ ë Œë”ë§í•˜ì§€ ì•ŠìŒ
                    const isLocationMessage = msg.content && msg.content.startsWith('[LOCATION_SELECTED:');

                    if (!isLocationMessage) {
                        renderMessageByType(msg, newContent);
                    }
                });
                container.innerHTML = ''; // ë¹„ìš°ìë§ˆì
                container.appendChild(newContent); // ì¦‰ì‹œ ì‚½ì… (ê¹œë¹¡ì„ ìµœì†Œí™”)
            }
        } catch (err) {
            if (isLocal) console.error("[ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜]:", err);
            container.innerHTML = `<p class="text-center text-red-500">ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜: ${err.message}</p>`;
        } finally {
            messageInput.disabled = false;
            connectWebSocket(roomId, idToken);
            scrollToBottom(container);
        }
    }

    // ë©”ì‹œì§€ ì „ì†¡
    async function sendMessage() {
        const messageText = messageInput.value.trim();
        if (!messageText) return;

        // ë°©ì´ ì•„ì§ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš° (ë©”ì‹œì§€ íì‰ ë¡œì§)
        if (currentRoomId === null) {
            // ì¤‘ë³µ ë°©ì§€: ì´ë¯¸ íì— ìˆëŠ” ë©”ì‹œì§€ëŠ” ì¶”ê°€í•˜ì§€ ì•ŠìŒ
            if (!messageQueue.includes(messageText)) {
                messageQueue.push(messageText); // ë©”ì‹œì§€ë¥¼ íì— ì¶”ê°€

                // ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ (Optimistic UI)
                const userMsg = { 
                    role: 'user', 
                    content: messageText, 
                    senderId: currentUserUid 
                };
                chatArea.appendChild(createTextMessage(userMsg));
                scrollToBottom(chatArea);
                
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                messageInput.value = '';
                sendButton.classList.remove('active');
            }
            
            // ë°© ìƒì„±ì´ ì§„í–‰ ì¤‘ì´ ì•„ë‹ˆë©´ ì‹œì‘
            if (!isCreatingRoom) {
                await createChatRoom();
            }
            
            return;
        }

        // WebSocket ì—°ê²°ì´ ëŠì–´ì§„ ê²½ìš°
        if (!isWebSocketConnected) {
            alert("ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.");
            return;
        }
        
        // ìœ„ì¹˜ ì •ë³´ëŠ” í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
        const isLocationMessage = messageText.startsWith('[LOCATION_SELECTED:');

        // ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì¤‘ ì¼ë°˜ ë©”ì‹œì§€ë§Œ ë Œë”ë§ (í ì²˜ë¦¬ ì¤‘ì´ ì•„ë‹ ë–„ë§Œ í™”ë©´ì— í‘œì‹œ)
        if (!isLocationMessage && !isProcessingQueue) {
            const userMsg = { role: 'user', content: messageText, senderId: currentUserUid};
            chatArea.appendChild(createTextMessage(userMsg));
        }

        const isSpecialTag = messageText.startsWith('[LOCATION_SELECTED:');

        if (isExpectingAddress && !isSpecialTag) {
            // ìœ„ì¹˜ ì…ë ¥ì„ ê¸°ëŒ€í•˜ëŠ” ìƒíƒœì´ê³ , íŠ¹ìˆ˜ íƒœê·¸ê°€ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¼ë©´ ì£¼ì†Œë¡œ ê°„ì£¼
            messageInput.disabled = true; 
            
            const success = await geocodeAddressAndSend(messageText);
            
            messageInput.disabled = false; 
            
            // ì„±ê³µì ìœ¼ë¡œ ì£¼ì†Œ ë³€í™˜ ë° íŠ¹ìˆ˜ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ
            if (success) {
                messageInput.value = ''; 
                sendButton.classList.remove('active');
                isExpectingAddress = false;
                return; 
            } 
            
            // ì‹¤íŒ¨ ì‹œ ì¬ì…ë ¥ ìœ ë„ë¥¼ ìœ„í•´ ì…ë ¥ì°½ë§Œ ì´ˆê¸°í™”í•˜ê³  ìƒíƒœëŠ” ìœ ì§€
            messageInput.value = ''; 
            sendButton.classList.remove('active');
            return;
        }

        // ë©”ì‹œì§€ ì „ì†¡ í›„ ì´ˆê¸°í™”
        scrollToBottom(chatArea);
        messageInput.value = '';
        sendButton.classList.remove('active');
        messageInput.disabled = true;

        // ë¡œë”© UI í‘œì‹œ (1:1 ì±„íŒ…ì´ê±°ë‚˜ ê·¸ë£¹ì±„íŒ…ì—ì„œ @ë°¥í’€ì´ë¥¼ í˜¸ì¶œí•œ ê²½ìš°)
        const shouldShowLoading = !currentChatroomIsGroup || messageText.includes('@ë°¥í’€ì´');
        let loadingDiv = null;
        if (shouldShowLoading) {
            loadingDiv = renderLoadingIndicator();
        }

        // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
        try {
            websocket.send(JSON.stringify({
                type: 'message',
                content: messageText
            }));
        } catch (err) {
            handleApiError(err, loadingDiv, chatArea, "ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            messageInput.disabled = false;
        }
    }

    // ìœ„ì¹˜ ì •ë³´ ì„œë²„ë¡œ ì „ì†¡
    async function sendLocationSelection(lat, lon, actionType) {
        const messageInput = document.getElementById('messageInput');
        const originalValue = messageInput.value;
        
        const backendMessage = `[LOCATION_SELECTED:${actionType}]|${lat}|${lon}`; 
        messageInput.value = backendMessage;
        
        try {
            await sendMessage(); 

        } catch (error) {
            console.error("ìœ„ì¹˜ ì •ë³´ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        }
    }

    /* =========================================================
    * ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    * ======================================================= */
    // í˜„ì¬ ìœ„ì¹˜ (gps) ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    function handleCurrentLocationSelection() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    sendLocationSelection(lat, lon, 'CURRENT_LOCATION');
                },
                (error) => {
                    console.error("Geolocation error:", error);
                    let errorMessage = 'GPS ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    if (error.code === error.PERMISSION_DENIED) {
                        errorMessage += ' ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                    }
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        } else {
            // GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì¸ ê²½ìš°
            console.error('í˜„ì¬ ë¸Œë¼ìš°ì €ê°€ GPS ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'text');
        }
    }

    // ì €ì¥ëœ ìœ„ì¹˜ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ 
    function handleSavedLocationSelection(button) {
        const lat = button.getAttribute('data-lat');
        const lon = button.getAttribute('data-lon');

        if (lat && lon) {
            sendLocationSelection(lat, lon, 'SAVED_LOCATION');
        } else {
            console.error('ì €ì¥ëœ ìœ„ì¹˜ ì •ë³´ì— ì¢Œí‘œê°€ ëˆ„ë½ë˜ì–´ ì‹ë‹¹ ì¶”ì²œì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'text');
        }
    }

    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.isComposing) {
            event.preventDefault(); 
            sendMessage(); 
        }
    });

    messageInput.addEventListener('input', () => {
        if (messageInput.value.trim() !== '') {
            sendButton.classList.add('active');
        } else {
            sendButton.classList.remove('active');
        }
    });

    sendButton.addEventListener('click', sendMessage);

    // ìœ„ì¹˜ ì„¤ì • ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.addEventListener('click', (event) => {
        const button = event.target.closest('.location-select-button');

        if (button) {
            const action = button.getAttribute('data-action');
            
            // í˜„ì¬ ìœ„ì¹˜ ì‚¬ìš© (GPS) ë²„íŠ¼ í´ë¦­ ì‹œ
            if (action === 'CURRENT_LOCATION') {
                handleCurrentLocationSelection();
            } 
            
            // ì €ì¥ëœ ìœ„ì¹˜ ì‚¬ìš© (SAVED_LOCATION) ë²„íŠ¼ í´ë¦­ ì‹œ
            else if (action === 'SAVED_LOCATION') {
                handleSavedLocationSelection(button);
            } 
        }
    });

    window.addEventListener('beforeunload', () => {
        if (websocket) {
            websocket.close();
        }
    });

    /* =========================================================
    * ìœ„ì¹˜ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° ë° ìƒíƒœ
    * ======================================================= */
    let kakaoPlaces = null;
    // ì‚¬ìš©ìì˜ ë‹¤ìŒ ë©”ì‹œì§€ê°€ ì£¼ì†Œì¸ì§€ ì—¬ë¶€ (ë©”ë‰´ ì„ íƒ í›„ ì£¼ì†Œ ì…ë ¥ì„ ê¸°ëŒ€í•˜ëŠ” ìƒíƒœ)
    let isExpectingAddress = false; 

    // Kakao Places ì´ˆê¸°í™” í•¨ìˆ˜
    function initializeKakaoPlaces() {
        if (typeof kakao !== 'undefined' && kakao.maps && kakao.maps.services) {
            kakaoPlaces = new kakao.maps.services.Places();
        } else {
            console.warn("Kakao Maps SDK (services, places) is not yet loaded.");
        }
    }

    // ì£¼ì†Œ ë¬¸ìì—´ì„ ì¢Œí‘œë¡œ ë³€í™˜í•˜ê³  íŠ¹ìˆ˜ ë©”ì‹œì§€ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” í•¨ìˆ˜
    async function geocodeAddressAndSend(addressText) {
        if (!kakaoPlaces) {
            alert("ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            return false;
        }
        
        return new Promise((resolve) => {
            // Kakao Placesì˜ keywordSearchë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì†Œë¥¼ ê²€ìƒ‰
            kakaoPlaces.keywordSearch(addressText, async (data, status) => {
                if (status === kakao.maps.services.Status.OK) {
                    const firstPlace = data[0];
                    const lat = firstPlace.y; // ìœ„ë„
                    const lon = firstPlace.x; // ê²½ë„
                    
                    await sendLocationSelection(lat, lon, 'MANUAL_LOCATION'); 
                    
                    resolve(true); // ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ ì™„ë£Œ
                } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                    alert(`'${addressText}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ì£¼ì†Œ ë˜ëŠ” ì¥ì†Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    resolve(false); // ì „ì†¡ ì‹¤íŒ¨
                } else {
                    alert('ì£¼ì†Œ/ì¥ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                    resolve(false); // ì „ì†¡ ì‹¤íŒ¨
                }
            }, {
                size: 1, 
            });
        });
    }

    
    /* =========================================================
    * ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ ë° ì´ˆê¸°í™”
    * ======================================================= */
    
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'index.html';
            return;
        }

        idToken = await user.getIdToken();
        currentUserUid = user.uid;

        const urlParams = new URLSearchParams(window.location.search);
        const urlRoomId = urlParams.get('roomId');
        const isNew = urlParams.get('isNew') === 'true'

        initializeKakaoPlaces();


        if (urlRoomId) {
            currentRoomId = urlRoomId;

            // ìƒˆë¡œ ìƒì„±ëœ ë°©(isNew)ì¸ ê²½ìš°ì—ë§Œ í•˜ë“œì½”ë”© ì¸ì‚¬ë§ì„ ë³´ì—¬ì¤Œ
            if (isNew) {
                showHeadlineMessage();
            } else {
                chatArea.innerHTML = '<p class="text-center text-gray-500">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            }

            isRoomReady = true;
            messageQueue = []; 
            await loadMessages(urlRoomId, chatArea);
        } else {
            isRoomReady = false; // ìƒˆ ì±„íŒ…ë°©ì€ ì¤€ë¹„ë˜ì§€ ì•Šì€ ìƒíƒœ
            messageQueue = [];
            showHeadlineMessage();
            await createChatRoom(); 
        }
    });
</script>
</body>
</html>
