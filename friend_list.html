<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밥픽 - 친구 목록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

    <header class="p-4 border-b border-gray-200 flex-shrink-0 bg-white">
        <div class="flex items-center">
            <a href="mypage.index.html" class="text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 19l-7-7 7-7" />
                </svg>
            </a>

            <h1 class="text-xl font-bold text-gray-800 text-center flex-1 pr-6">친구 목록</h1>
        </div>
    </header>

    <div class="p-4 flex-shrink-0 bg-white shadow-sm">
        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
            <input type="text" id="search-input" placeholder="닉네임으로 친구를 검색하세요..."
                class="flex-1 p-3 text-gray-700 focus:outline-none">
            <button id="search-button" class="p-3 bg-[#ff7242] text-white hover:bg-indigo-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
            </button>
        </div>
    </div>

    <div id="search-results-section" class="p-4 pt-0 hidden">
        <h2 class="text-lg font-semibold text-gray-700 mt-4 mb-2">검색 결과</h2>
        <div id="search-results-container"></div>
    </div>

    <main id="friend-list-main" class="flex-1 p-4 overflow-y-auto">
        <h2 class="text-lg font-semibold text-gray-700 mb-2">내 친구 목록</h2>
        <div id="friend-list-container">
            <p class="text-center text-gray-500 mt-10">친구 목록을 불러오는 중...</p>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const fastapiUrl = "https://bapick.duckdns.org"

        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResultsContainer = document.getElementById('search-results-container');
        const searchResultsSection = document.getElementById('search-results-section');
        const friendListContainer = document.getElementById('friend-list-container');
        const friendListMain = document.getElementById('friend-list-main');

        let idToken = null;

        // 한국어 초성 추출을 위한 헬퍼 함수
        function getKoreanInitial(char) {
            if (char === undefined || char.length === 0) return '#';
            const code = char.charCodeAt(0) - 44032;
            if (code < 0 || code > 11172) return '#';
            const initial = Math.floor(code / 588);
            const initialConsonants = [
                'ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ',
                'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'
            ];
            return initialConsonants[initial];
        }

        // =========================================================
        // 0. 초기화 및 인증 상태 확인
        // =========================================================

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('로그인이 필요합니다.');
                window.location.href = 'index.html';
                return;
            }
            idToken = await user.getIdToken();
            // 로그인 후 기존 친구 목록 로드
            fetchFriendList();
        });


        // =========================================================
        // 1. API: 기존 친구 목록 가져오기 (GET /friends/list)
        // =========================================================

        async function fetchFriendList() {
            if (!idToken) return;

            try {
                const response = await fetch(`${fastapiUrl}/api/friends/list`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) {
                    throw new Error(`목록 불러오기 실패: ${response.status}`);
                }

                const data = await response.json();
                renderFriendListByInitial(data.friends || []);

            } catch (error) {
                console.error("친구 목록 로드 중 오류 발생:", error);
                friendListContainer.innerHTML = `<p class="text-center text-red-500 mt-10">친구 목록을 불러오는 데 실패했습니다.</p>`;
            }
        }

        // =========================================================
        // 2. UI 로직: 초성별 친구 목록 렌더링
        // =========================================================

        function renderFriendListByInitial(friends) {
            friendListContainer.innerHTML = '';
            if (friends.length === 0) {
                friendListContainer.innerHTML = `<p class="text-center text-gray-500 mt-10">등록된 친구가 없습니다.</p>`;
                return;
            }

            // 1. 친구 목록을 초성별로 그룹화
            const groupedFriends = friends.reduce((groups, friend) => {
                const initial = getKoreanInitial(friend.nickname ? friend.nickname.charAt(0) : '#');
                if (!groups[initial]) {
                    groups[initial] = [];
                }
                groups[initial].push(friend);
                return groups;
            }, {});

            // 2. 초성 키를 정렬 (ㄱㄴㄷ 순)
            const sortedInitials = Object.keys(groupedFriends).sort((a, b) => {
                if (a === '#') return 1;
                if (b === '#') return -1;
                return a.localeCompare(b);
            });

            // 3. 그룹별로 렌더링
            sortedInitials.forEach(initial => {
                const initialHeader = document.createElement('h3');
                initialHeader.className = 'sticky top-0 bg-gray-50 text-[#ff7242] font-bold text-sm py-1 border-b border-gray-200 mt-4';
                initialHeader.textContent = initial;
                friendListContainer.appendChild(initialHeader);

                groupedFriends[initial].forEach(friend => {
                    const friendCard = createFriendCard(friend, 'friend');
                    friendListContainer.appendChild(friendCard);
                });
            });
        }


        // =========================================================
        // 3. API: 친구 검색 및 렌더링 (GET /friends/search)
        // =========================================================

        async function fetchSearchResults(query) {
            if (!idToken) return [];

            // 검색 시작 시 기존 목록 숨기고 검색 결과 표시
            searchResultsSection.classList.remove('hidden');
            friendListMain.classList.add('hidden');
            searchResultsContainer.innerHTML = `<p class="text-center text-indigo-500 mt-4">검색 중...</p>`;

            try {
                const encodedQuery = encodeURIComponent(query.trim());
                const response = await fetch(`${fastapiUrl}/api/friends/search?query=${encodedQuery}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                renderSearchResults(data.users || []);

            } catch (error) {
                console.error("친구 검색 중 오류 발생:", error);
                searchResultsContainer.innerHTML = `<p class="text-center text-red-500 mt-4">검색에 실패했습니다. 서버를 확인하세요.</p>`;
            }
        }

        // 검색 결과 렌더링 함수
        function renderSearchResults(users) {
            searchResultsContainer.innerHTML = '';

            if (users.length === 0) {
                searchResultsContainer.innerHTML = `<p class="text-center text-gray-500 mt-4">검색 결과가 없습니다.</p>`;
                return;
            }

            users.forEach(user => {
                const userCard = createFriendCard(user, user.relation_status);
                searchResultsContainer.appendChild(userCard);
            });
        }

        // =========================================================
        // 4. API: 친구 삭제 (DELETE /friends/{target_user_uid})
        // =========================================================
        async function deleteFriend(targetUid) {
            if (!idToken) return false;

            if (!confirm('정말로 이 친구를 삭제하시겠습니까?')) {
                return false;
            }

            try {
                const response = await fetch(`${fastapiUrl}/api/friends/${targetUid}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (response.status === 404) {
                    alert("친구 관계를 찾을 수 없습니다. (이미 삭제되었거나 잘못된 요청)");
                    return true; // 목록에서는 삭제되어야 하므로 성공으로 간주
                }

                if (response.status !== 204) { // 204 No Content
                    throw new Error(`친구 삭제 실패: ${response.status}`);
                }

                alert("친구가 삭제되었습니다.");
                return true;

            } catch (error) {
                console.error("친구 삭제 중 오류 발생:", error);
                alert(`친구 삭제 실패: ${error.message}`);
                return false;
            }
        }

        // =========================================================
        // 5. 공통 UI 컴포넌트: 친구 카드 생성
        // =========================================================
        function createFriendCard(user, status) {
            const card = document.createElement('div');
            card.className = 'flex items-center justify-between p-3 my-1 bg-white rounded-lg shadow-sm';

            const profileImageUrl = user.profile_image && user.profile_image.trim() !== ''
                ? user.profile_image
                : 'assets/images/default-profile.jpg';

            card.innerHTML = `
            <div class="flex items-center">
                <img class="h-12 w-12 rounded-full object-cover" src="${profileImageUrl}" alt="${user.nickname}님의 프로필 사진">
                <span class="ml-4 font-semibold text-gray-800">${user.nickname || '이름 없음'}</span>
            </div>
            <button data-target-uid="JbNBZckFroXbOpTsUWxIxBRMB2s1" class="delete-friend-btn px-3 py-1 text-sm text-red-600 border border-red-600 rounded-full hover:bg-red-50 transition duration-150">
                친구 삭제
            </button>
        `;
            return card;
        }

        // =========================================================
        // 6. 이벤트 리스너
        // =========================================================

        // 검색 버튼 클릭 이벤트
        searchButton.addEventListener('click', () => {
            const query = searchInput.value;
            if (query.trim()) {
                fetchSearchResults(query);
            } else {
                // 검색어가 없을 경우 기존 목록으로 복귀
                searchResultsSection.classList.add('hidden');
                friendListMain.classList.remove('hidden');
                fetchFriendList(); // 목록 새로고침
            }
        });

        // 엔터 키 입력 시 검색 이벤트
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchButton.click();
            }
        });

        // 친구 요청 버튼 클릭 이벤트 위임
        friendListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-friend-btn')) {
                const targetUid = e.target.dataset.targetUid;

                const success = await deleteFriend(targetUid);

                if (success) {
                    // 삭제 성공 시, 친구 목록을 새로고침하고 현재 필터링 상태 유지
                    await fetchFriendList();
                    // fetchFriendList 안에서 filterFriendList()를 호출하므로 별도로 호출할 필요 없음.
                }
            }
        });
    </script>
</body>

</html>