<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>스크랩 - 전체 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>

<body class="bg-gray-50">    
    <div class="h-full flex flex-col">
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200 flex-shrink-0 bg-white">
            <!-- 뒤로가기 버튼 (스크랩 페이지로 이동) -->
            <div class="justify-self-start">
                <a href="/scrap/index" id="header-back-button" class="p-1 block rounded-full text-gray-600 hover:bg-gray-100 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
                    </svg>
                </a>
            </div>

            <!-- 해당 컬렉션 이름 -->
            <h1 class="text-xl font-bold text-center text-gray-800">모든 스크랩</h1>

            <!-- 컬렉션 삭제 버튼 -->
            <div class="justify-self-end relative">
                <button id="delete-collection-button" hidden class="p-1 rounded-full text-red-600 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                    </svg>
                </button>
            </div>
        </header>

        <main id="list-content" class="flex-1 overflow-y-auto p-4">
            <div id="restaurant-grid" class="grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-5"></div>
            <p class="text-center text-gray-500 mt-4">스크랩 목록을 불러오는 중...</p>
        </main>
    </div>

    <!-- 모달 오버레이 -->
    <div id="custom-modal-overlay" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>

    
    <!-- 컬렉션 삭제 모달 -->
    <div id="custom-confirm-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl p-6 z-50 w-80 hidden">
        <p id="confirm-message" class="text-gray-700 mb-6 text-center text-base font-medium">
            컬렉션을 정말 삭제하시겠습니까? 컬렉션 내 식당 스크랩은 유지됩니다.
        </p>
        <div class="flex justify-around gap-3">
            <button id="confirm-cancel-btn" class="flex-1 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                취소
            </button>
            <button id="confirm-ok-btn" class="flex-1 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                삭제
            </button>
        </div>
    </div>
    
    <!-- 토스트 -->
    <div id="custom-toast"
        class="fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-[70] transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

        let currentCollectionName = null;
        let isAppInitialized  = false; // 앱 초기화 여부 플래그

        const pathParts = window.location.pathname.split('/');
        const collectionIdParam = pathParts[pathParts.length - 1];
        const collectionId = collectionIdParam ? parseInt(collectionIdParam, 10) : null;

        const NO_IMAGE_URL = '/assets/images/restaurant-default.png';

        const listContent = document.getElementById('list-content');
        const headerTitle = document.querySelector('header h1');
        const deleteButton = document.getElementById('delete-collection-button');

        const customToast = document.getElementById('custom-toast');
        const toastDuration = 2500;

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const confirmModal = document.getElementById('custom-confirm-modal');
        const confirmMessageEl = document.getElementById('confirm-message');
        const confirmOkBtn = document.getElementById('confirm-ok-btn');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

        /* UI 피드백 */
        function showCustomToast(message) {
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

            setTimeout(() => {
                customToast.classList.remove('opacity-100');
                customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }

        // 커스텀 컨펌 모달 (확인/취소를 resolve)
        function showCustomConfirm(message) {
            return new Promise(resolve => {
                confirmMessageEl.classList.add('whitespace-pre-line');
                confirmMessageEl.textContent = message;
                modalOverlay.classList.remove('hidden');
                confirmModal.classList.remove('hidden');

                const handleOk = () => {
                    cleanup();
                    resolve(true);
                };

                const handleCancel = () => {
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    modalOverlay.classList.add('hidden');
                    confirmModal.classList.add('hidden');
                    confirmOkBtn.removeEventListener('click', handleOk);
                    confirmCancelBtn.removeEventListener('click', handleCancel);
                };

                confirmOkBtn.addEventListener('click', handleOk);
                confirmCancelBtn.addEventListener('click', handleCancel);
            });
        }

        /* API 호출 */
        // 모든 스크랩  조회
        async function getAllScraps(user) {
            try {
                const idToken = await user.getIdToken();
                const response = await fetch(`${API_URL}/api/scraps`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || '모든 스크랩을 불러오는 데 실패했습니다.');
                }
                
                let scrapsResponse = await response.json();
                return scrapsResponse;     
            } catch (error) {
                if (isLocal) console.error("[모든 스크랩 조회 에러]:", error);
                listContent.innerHTML = `<p class="text-center text-red-500 mt-4">모든 스크랩을 불러오던 중 오류가 발생했습니다.</p>`;
            }
        }

        // 특정 컬렉션(collectionId)의 스크랩 목록 조회
        async function getScrapsByCollection(user) {
            try {
                const idToken = await user.getIdToken();
                const response = await fetch(`${API_URL}/api/collections/${collectionId}/scraps`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || '해당 컬렉션의 스크랩 조회 중 오류가 발생했습니다.');
                }
                
                let scrapsResponse = await response.json();
                return scrapsResponse;   
            } catch (error) {
                if (isLocal) console.error(`[${collectionId} 스크랩 조회 에러]:`, error);
                listContent.innerHTML = `<p class="text-center text-red-500 mt-4">해당 컬렉션의 스크랩 조회 중 오류가 발생했습니다.</p>`;
            }
        }

        // 현재 컬렉션(collectionId)을 삭제
        async function deleteCollection(user) {
            try {
                const idToken = await user.getIdToken();

                const response = await fetch(`${API_URL}/api/collections/${collectionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || `컬렉션 삭제에 실패했습니다.`);
                }

                // 성공 시 컬렉션 메인 페이지로 리다이렉션
                window.location.href = '/scrap/index';
            } catch (error) {
                if (isLocal) console.error('컬렉션 삭제 API 호출 중 오류 발생:', error);
                showCustomToast(`컬렉션 삭제에 실패했습니다.`); 
            }
        }


        /* 페이지 상태 정리 & 렌더링 */
        // 스크랩 API 응답을 정규화하고, UI 상태 결정 및 렌더링 트리거
        function setupScrapsPage(scrapsResponse) {
            // 데이터 정규화: scraps 키가 있으면 그 안의 배열을 쓰고, 없으면 scrapsResponse 자체가 배열
            const scraps = scrapsResponse.scraps ? scrapsResponse.scraps : scrapsResponse;
            
            // ui 업데이트
            if (scrapsResponse.collectionName) {
                currentCollectionName = scrapsResponse.collectionName;
                document.title = `스크랩 - ${scrapsResponse.collectionName} - Bapick`;
                headerTitle.textContent = scrapsResponse.collectionName;
                deleteButton.hidden = false;
            } 

            renderScraps(scraps);
        }

        // 스크랩 목록 렌더링
        function renderScraps(scraps) {
            listContent.innerHTML = '';

            // 해당 컬렉션에 스크랩이 없을 경우
            if (!scraps || scraps.length === 0) {
                listContent.innerHTML = '<p class="text-center text-gray-500 mt-4">스크랩한 식당이 없습니다.</p>';
                return;
            } 
            
            const fragment = document.createDocumentFragment();
            scraps.forEach(scrap => {
                fragment.appendChild(createScrapCard(scrap));
            });

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4';

            grid.appendChild(fragment);
            listContent.appendChild(grid);                     
        }

        // 개별 스크랩 카드 생성
        function createScrapCard(scrap) {
            const restaurant = scrap.restaurant;

            const cardLink = document.createElement('a');
            cardLink.href = `/restaurant/detail/${restaurant.id}`;
            cardLink.className = 'block';

            const card = document.createElement('div');
            card.className =
                'bg-white rounded-xl shadow-md overflow-hidden cursor-pointer transition-transform transform hover:scale-105';

            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'relative aspect-square';

            const img = document.createElement('img');
            img.src = getRestaurantImageUrl(restaurant);
            img.alt = `${restaurant.name} 대표 이미지`;
            img.className = 'absolute inset-0 w-full h-full object-cover';

            imgWrapper.appendChild(img);

            const textWrapper = document.createElement('div');
            textWrapper.className = 'p-3';

            const title = document.createElement('h3');
            title.className = 'text-sm font-bold text-gray-800 truncate';
            title.textContent = restaurant.name;

            const category = document.createElement('p');
            category.className = 'text-xs text-gray-500 truncate';
            category.textContent = restaurant.category;

            textWrapper.append(title, category);
            card.append(imgWrapper, textWrapper);
            cardLink.appendChild(card);

            return cardLink;
        }

        
        // 식당 이미지 URL 파싱: 첫 번째 이미지만 추출
        function getRestaurantImageUrl(restaurant) {
            if (typeof restaurant.image !== 'string') return NO_IMAGE_URL;

            const images = restaurant.image
                .split(',')
                .map(url => url.trim())
                .filter(Boolean);

            return images.length > 0 ? images[0] : NO_IMAGE_URL;
        }

        /* 앱 초기화 및 이벤트 바인딩 */
        async function initApp(user) {
            if (isAppInitialized) return; // 이미 초기화됐다면 중복 실행 방지
            isAppInitialized = true;

            let scrapsResponse = null;

            //  collectionId 유무에 따라 API 호출 분기
            if (collectionId) {
                // 특정 컬렉션 스크랩 로드
                scrapsResponse = await getScrapsByCollection(user);
            } else {
                // 모든 스크랩 로드
                scrapsResponse = await getAllScraps(user);
            }

            if (scrapsResponse) {
                setupScrapsPage(scrapsResponse);
            }

            // 컬렉션 삭제 버튼 이벤트 등록
            deleteButton.onclick = async () => {
                if (!collectionId || collectionId === 'null') {
                    return; // '모든 스크랩' 페이지에서는 동작하지 않음
                }

                const confirmationMessage = `'${currentCollectionName}' 컬렉션을 정말 삭제하시겠습니까?\n컬렉션 내 식당 스크랩은 유지됩니다.`;
                const shouldDelete = await showCustomConfirm(confirmationMessage);

                if (!shouldDelete) {
                    return; // 사용자가 '취소'를 누르면 여기서 종료
                }
                        
                await deleteCollection(user);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                initApp(user); 
            } else {
                showCustomToast("로그인이 필요한 페이지입니다.");
                setTimeout(() => { window.location.href = '/index'; }, 1000);
            }
        });
    </script>
</body>

</html>