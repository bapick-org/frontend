<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>홈 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .profile-image-container {
            padding: 5px;
            background: linear-gradient(45deg, #FDBF8A, #E77A6C, #F0A05E);
            border-radius: 9999px;
        }

        .progress-bar-wood {
            background-color: #4CAF50;
        }

        .progress-bar-earth {
            background-color: #8D6E63;
        }

        .progress-bar-metal {
            background-color: #FFB300;
        }

        .progress-bar-fire {
            background-color: #EF5350;
        }

        .progress-bar-water {
            background-color: #42A5F5;
        }

        .popup-hidden {
            opacity: 0;
            transform: translate(-50%, 10px) scale(0.9);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease, visibility 0s 0.2s;
            visibility: hidden;
        }

        .popup-visible {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
            pointer-events: auto;
            transition: opacity 0.2s ease, transform 0.2s ease;
            visibility: visible;
        }

        /* 스크롤바 숨김 (모바일 뷰 유지) */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* [추가] 드래그 씹힘 방지: 이미지나 링크가 파일처럼 끌리는 현상 제거 */
        #restaurant-carousel img,
        #restaurant-carousel a {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            -user-drag: none;
            -webkit-user-select: none;
            user-select: none;
        }
    </style>
</head>

<body class="m-0 bg-[#FF7242] overflow-x-hidden">
    <header class="fixed top-0 left-0 right-0 h-16 bg-[#FF7242] z-20">
        <div id="header-main" class="flex items-center justify-start h-full px-4 max-w-screen-xl mx-auto">
            <div class="flex items-center gap-2">
                <h1 class="text-xl font-bold text-gray-800">Bapick!</h1>
            </div>
        </div>
    </header>

    <div class="mt-16 relative flex items-center w-full bg-[#FF7242] px-4 py-4">
        <div class="max-w-screen-xl mx-auto w-full relative">
            <input type="text" id="location-text"
                class="w-full pl-5 pr-16 py-3 bg-white/80 backdrop-blur-sm border-none rounded-full shadow-lg focus:ring-2 focus:ring-[#FF7242] focus:outline-none text-gray-800 placeholder-gray-400">
            <a href="/settings/location"
                class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-[#FF7242] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-md transition-transform transform hover:scale-110">
                <span class="material-symbols-outlined">location_on</span>
            </a>
        </div>
    </div>

    <main class="w-full mx-auto bg-slate-100 rounded-t-3xl p-4 lg:p-6 lg:pt-8 min-h-[calc(100vh-10rem)] pb-24 lg:mt-4">
        <div class="max-w-md lg:max-w-screen-xl w-full mx-auto">

            <div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-6 mb-6">
                <div id="combined-profile-card"
                    class="bg-white backdrop-blur-sm rounded-2xl shadow-lg p-6 flex flex-col lg:flex-row lg:items-start lg:gap-8">

                    <!-- 사용자 프로필 및 사주 오행 -->
                    <div class="flex flex-col items-center lg:items-center lg:w-1/2">
                        <div id="profile-content" class="mb-6 text-center">
                            <h2 id="user-nickname" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="user-birthdate" class="text-sm text-gray-500"></p>
                        </div>

                        <div class="flex flex-col gap-4 items-center lg:flex-row lg:items-center lg:gap-8 w-full">
                            <div class="profile-image-container flex-shrink-0 w-auto max-w-[122px]">
                                <img id="user-profile-image"
                                    class="w-24 h-24 sm:w-28 sm:h-28 rounded-full object-cover border-4 border-white"
                                    src="/assets/images/default-profile.jpg"
                                    alt="프로필 사진">
                            </div>

                            <div id="stats-container" class="flex flex-col space-y-3 w-full">
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 flex items-center justify-center" title="목 (Wood)"><span
                                            class="material-symbols-outlined text-[#4CAF50]">nature</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="stat-wood" class="h-full rounded-full progress-bar-wood"
                                            style="width: 0%;">
                                        </div>
                                    </div>
                                    <span id="stat-wood-value" class="font-bold text-gray-700 w-8 text-left"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 flex items-center justify-center" title="화 (Fire)"><span
                                            class="material-symbols-outlined text-[#EF5350]">local_fire_department</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="stat-fire" class="h-full rounded-full progress-bar-fire"
                                            style="width: 0%;">
                                        </div>
                                    </div>
                                    <span id="stat-fire-value" class="font-bold text-gray-700 w-8 text-left"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 flex items-center justify-center" title="토 (Earth)"><span
                                            class="material-symbols-outlined text-[#8D6E63]">landscape</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="stat-earth" class="h-full rounded-full progress-bar-earth"
                                            style="width: 0%;">
                                        </div>
                                    </div>
                                    <span id="stat-earth-value" class="font-bold text-gray-700 w-8 text-left"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 flex items-center justify-center" title="금 (Metal)"><span
                                            class="material-symbols-outlined text-[#FFB300]">paid</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="stat-metal" class="h-full rounded-full progress-bar-metal"
                                            style="width: 0%;">
                                        </div>
                                    </div>
                                    <span id="stat-metal-value" class="font-bold text-gray-700 w-8 text-left"></span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <div class="w-6 h-6 flex items-center justify-center" title="수 (Water)"><span
                                            class="material-symbols-outlined text-[#42A5F5]">water_drop</span></div>
                                    <div class="w-full bg-gray-200 rounded-full h-4">
                                        <div id="stat-water" class="h-full rounded-full progress-bar-water"
                                            style="width: 0%;">
                                        </div>
                                    </div>
                                    <span id="stat-water-value" class="font-bold text-gray-700 w-8 text-left"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 오행 메시지 -->
                    <div id="recommendation-content" class="mt-6 lg:mt-0 lg:flex lg:flex-col lg:w-1/2 lg:self-end">
                        <div class="p-4 bg-[#FFEDC5]/50 border border-orange-200 rounded-xl shadow-inner">
                            <span id="recommendation-type"
                                class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-[#FF7242] text-white self-start"></span>
                            <h4 id="recommendation-headline" class="text-lg font-bold text-gray-800 mt-2"></h4>
                            <p id="recommendation-advice" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>



                <!-- 포춘쿠키 섹션  -->
                <div
                    class="fortune-cookie-widget bg-white backdrop-blur-sm rounded-2xl shadow-lg p-8 flex flex-col gap-8">

                    <h3 class="text-xl font-bold text-gray-800 text-left">오늘의 포춘쿠키</h3>

                    <div id="closedCookieSection" class="flex flex-col items-center">
                        <img src="/assets/images/fortune-cookie-closed.png" alt="닫힌 포춘 쿠키" class="w-40 mx-auto animate-pulse">
                    </div>

                    <div id="openedCookieSection" class="hidden flex flex-col items-center text-center">
                        <img src="/assets/images/fortune-cookie-open.png" alt="열린 포춘 쿠키" class="w-60 mx-auto animate-fadeIn">
                        <p id="fortuneMessage" class="text-sm font-semibold text-gray-700 leading-relaxed mt-6"></p>
                    </div>

                    <button id="cookieActionButton"
                        class="w-full bg-gradient-to-r from-orange-400 to-red-500 text-white font-semibold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition duration-200">
                        열어보기
                    </button>

                </div>
            </div>
        </div>

        <!-- 식당 추천 -->
        <div
            class="mt-6 p-6 max-w-md lg:max-w-screen-xl w-full mx-auto bg-white backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
            <div class="pt-2 flex justify-between items-center">
                <h3 id="nearby-restaurants-heading" class="text-xl lg:text-2xl font-bold text-gray-800">
                    나의 근처 맛집
                </h3>
                <a href="/restaurant/list" class="text-base font-semibold text-gray-500 hover:text-[#FF7242]">
                    전체보기 &gt;
                </a>
            </div>
            <div class="relative mt-4 lg:mt-6">
                <div id="restaurant-carousel"
                    class="flex overflow-x-auto scrollbar-hide space-x-4 py-2 flex-nowrap cursor-grab active:cursor-grabbing select-none">
                    <p id="nearby-restaurants-loading" class="text-gray-500">주변 맛집 정보를 불러오는 중...</p>
                </div>
            </div>
        </div>

        </div>
    </main>

    <!-- 하단 메뉴바 -->
    <footer class="fixed bottom-0 left-0 right-0 z-30">
        <nav
            class="flex justify-around items-center h-16 bg-white rounded-t-2xl shadow-[0_-2px_10px_rgba(0,0,0,0.05)] max-w-screen-xl mx-auto">
            <a href="#" class="flex flex-col items-center justify-center w-1/5 h-full text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"
                    stroke-width="1.5">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span class="font-bold mt-1">홈</span>
            </a>
            <a href="/calender/index"
                class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="mt-1">캘린더</span>
            </a>
            <div class="w-1/5"></div>
            <a href="/scrap/index"
                class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                <span class="mt-1">스크랩</span>
            </a>
            <a href="/mypage/index"
                class="flex flex-col items-center justify-center w-1/5 h-full text-gray-500 hover:text-[#FF7242] text-xs">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span class="mt-1">마이</span>
            </a>
        </nav>
    </footer>

    <!-- FAB 버튼 (1:1 채팅방으로 이동) -->
    <a href="/chat/room" id="secondary-action-btn"
        class="fixed bottom-20 right-6 w-16 h-16 bg-[#FFF6E2] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-30"
        style="background-image: url('/assets/images/logo-main.png'); background-size: 132%; background-repeat: no-repeat; background-position: center 0.5%;">
    </a>

    <!-- 하단 메뉴바의 + 버튼 -->
    <button id="add-chat-btn"
        class="fixed bottom-6 left-1/2 -translate-x-1/2 w-16 h-16 bg-[#FF7242] hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-40">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- 오버레이 -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden"></div>

    <!-- + 버튼 클릭 시 팝업-->
    <div id="add-chat-popup" class="fixed bottom-24 left-1/2 -translate-x-1/2 w-48 bg-white rounded-md shadow-xl z-50 popup-hidden">
        <div class="py-2">
            <a href="/chat/index" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="8" y1="6" x2="21" y2="6"></line>
                    <line x1="8" y1="12" x2="21" y2="12"></line>
                    <line x1="8" y1="18" x2="21" y2="18"></line>
                    <line x1="3" y1="6" x2="3.01" y2="6"></line>
                    <line x1="3" y1="12" x2="3.01" y2="12"></line>
                    <line x1="3" y1="18" x2="3.01" y2="18"></line>
                </svg>
                채팅 목록
            </a>
            <a href="/chat/room" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                </svg>
                1:1 채팅방
            </a>
            <a href="/chat/create-group" class="flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                    <path d="M18 21v-2a4 4 0 0 0-4-4h-1" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M18 7h3a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-3" />
                    <path d="m15.5 13.5-3-3 3-3" />
                </svg>
                단체 채팅방
            </a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "/firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

        const userNameEl = document.getElementById('user-nickname');
        const userbirthdateEl = document.getElementById('user-birthdate');
        const userProfileImageEl = document.getElementById('user-profile-image');

        const recommendationTypeEl = document.getElementById('recommendation-type');
        const recommendationHeadlineEl = document.getElementById('recommendation-headline');
        const recommendationAdviceEl = document.getElementById('recommendation-advice');

        const locationTextEl = document.getElementById('location-text');
        const nearbyRestaurantsHeading = document.getElementById('nearby-restaurants-heading');

        // 오행 통계 요소 맵
        const statElements = {
            wood: { bar: document.getElementById('stat-wood'), value: document.getElementById('stat-wood-value') },
            fire: { bar: document.getElementById('stat-fire'), value: document.getElementById('stat-fire-value') },
            earth: { bar: document.getElementById('stat-earth'), value: document.getElementById('stat-earth-value') },
            metal: { bar: document.getElementById('stat-metal'), value: document.getElementById('stat-metal-value') },
            water: { bar: document.getElementById('stat-water'), value: document.getElementById('stat-water-value') }
        };

        // 저장된 위치를 불러오는 함수
        function loadSavedLocation() {
            const savedLocation = localStorage.getItem('savedBapickLocation');
            if (savedLocation) {
                const locationData = JSON.parse(savedLocation);
                // 저장된 위치의 주소 또는 장소 이름을 input 필드에 표시 (주소 우선)
                locationTextEl.value = locationData.address || locationData.name;
            } else {
                // 저장된 위치가 없으면, 기존의 GPS 기반 위치 찾기 실행
                updateLocation();
            }
        }

        // GPS 기반 현재 위치를 가져와 주소로 변환하는 함수
        async function updateLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=ko`);
                            if (!response.ok) {
                                throw new Error('Reverse geocoding API request failed');
                            }
                            const data = await response.json();
                            const address = data.address;

                            const city = address.city || address.province || '';
                            const district = address.suburb || address.neighbourhood || address.borough || address.city_district || '';

                            if (city && district) {
                                locationTextEl.value = `${city} ${district}`;
                            } else if (city) {
                                locationTextEl.value = city;
                            } else {
                                locationTextEl.value = '주소 정보 없음';
                            }
                        } catch (error) {
                            if (isLocal) console.error("Reverse geocoding error:", error);
                            locationTextEl.value = '주소를 변환할 수 없습니다.';
                        }
                    },
                    (error) => {
                        if (isLocal) console.error(`Geolocation error: ${error.code} - ${error.message}`);
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                locationTextEl.value = "위치 권한이 거부되었습니다.";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                locationTextEl.value = "위치 정보를 사용할 수 없습니다.";
                                break;
                            case error.TIMEOUT:
                                locationTextEl.value = "위치 정보를 가져오는데 시간이 초과되었습니다.";
                                break;
                            default:
                                locationTextEl.value = "알 수 없는 오류로 위치를 가져올 수 없습니다.";
                                break;
                        }
                    }
                );
            } else {
                locationTextEl.value = 'Geolocation을 지원하지 않습니다.';
            }
        }

        // 근처 식당 정보 렌더링
        const renderRestaurantCard = (restaurant) => {
            const defaultImageUrl = '/assets/images/restaurant-default.png';
            let imageUrl = defaultImageUrl;

            // 이미지 렌더링: image가 문자열인 동시에 비어있지 않은 경우 첫 번째 이미지 렌더링
            if (typeof restaurant.image === 'string' && restaurant.image.trim() !== '') {
                const images = restaurant.image.split(',').map(url => url.trim()).filter(url => url);
                if (images.length > 0) {
                    imageUrl = images[0];
                }
            }

            // 거리 정보 (m/km 변환 로직 추가)
            let distanceText = '';
            if (restaurant.distance_m !== undefined) {
                if (restaurant.distance_m < 1000) {
                    distanceText = `${restaurant.distance_m}m`;
                } else {
                    // 1km 이상: km 단위 (소수점 1자리)
                    distanceText = `${(restaurant.distance_m / 1000).toFixed(1)}km`;
                }
            }

            // 조건부 렌더링 (평점/리뷰)
            const ratingValue = restaurant.rating || 0;
            const reviewCount = restaurant.review_count || 0;
            let statsHtml = '';

            if (ratingValue > 0) {
                statsHtml = `
                    <div class="flex items-center text-xs md:text-sm text-gray-500 mb-1">
                        <span class="material-symbols-outlined text-yellow-500 text-sm md:text-base mr-1 fill-1">star</span>
                        <span class="font-semibold">${ratingValue.toFixed(1)}</span>
                        <span class="ml-2 text-gray-400">리뷰 ${reviewCount}개</span>
                    </div>
                `;
            } else if (reviewCount > 0) {
                statsHtml = `
                    <div class="flex items-center text-xs md:text-sm text-gray-500 mb-1">
                        <span class="text-gray-400">리뷰 ${reviewCount}개</span>
                    </div>
                `;
            }


            return `
                <a href="/restaurant/detail/${restaurant.id}" class="w-80 h-44 flex-shrink-0 flex bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow overflow-hidden">
                    
                    <div class="flex-shrink-0 w-32 h-full rounded-lg overflow-hidden"> 
                        <img class="w-full h-full object-cover" src="${imageUrl}" alt="${restaurant.name}">
                    </div>

                    <div class="p-4 flex-1 min-w-0">
                        <p class="text-xs md:text-sm text-orange-500 mb-0.5">${distanceText} 거리</p>
                        <h4 class="font-bold text-lg md:text-xl text-gray-800 truncate mb-1">${restaurant.name}</h4>
                        <p class="text-sm md:text-base text-gray-500 truncate mb-1 md:mb-2">${restaurant.category}</p>
                        ${statsHtml}
                        <p class="text-xs md:text-sm text-gray-400 truncate">${restaurant.address}</p>
                    </div>
                </a>
            `;
        };

        // 근처 식당 조회 api 호출
        const fetchNearbyRestaurants = async (idToken, restaurantIds) => {
            const carouselEl = document.getElementById('restaurant-carousel');
            let lat = null;
            let lon = null;

            try {
                // 1. 로컬 스토리지에서 저장된 위치를 먼저 시도
                const savedLocation = localStorage.getItem('savedBapickLocation');
                if (savedLocation) {
                    const locationData = JSON.parse(savedLocation);
                    lat = parseFloat(locationData.lat);
                    lon = parseFloat(locationData.lon || locationData.lng);
                }

                // 2. 저장된 위치가 없거나 유효하지 않으면 GPS 획득 시도
                if (lat === null || lon === null || isNaN(lat) || isNaN(lon)) {
                    const pos = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    lat = pos.coords.latitude;
                    lon = pos.coords.longitude;
                }

                const response = await fetch(`${API_URL}/api/restaurants/nearby?lat=${lat}&lon=${lon}&limit=15`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || data.detail || '주변 식당 정보를 가져오지 못했습니다.');
                }

                const restaurants = Array.isArray(data) ? data : [];

                // 추천 식당 목록을 로컬 스토리지에 저장
                try {
                    localStorage.setItem('recommendedRestaurants', JSON.stringify(restaurants));
                } catch (e) {
                    if (isLocal) console.error("로컬 스토리지 저장 실패:", e);
                }

                if (restaurants.length === 0) {
                    carouselEl.innerHTML = '<p class="text-gray-500 p-3">현재 위치 기준 식당이 없습니다.</p>';
                    return;
                }

                // 로딩 메시지 제거 및 식당 목록 렌더링
                carouselEl.innerHTML = '';
                restaurants.forEach(rest => {
                    carouselEl.insertAdjacentHTML('beforeend', renderRestaurantCard(rest));
                });

            } catch (err) {
                if (isLocal) console.error("Restaurant fetch failed:", err);
                carouselEl.innerHTML = `<p class="text-gray-500 p-3">식당 정보를 불러오는 중 오류가 발생했습니다.</p>`;
            }
        };

        // 홈 화면 초기화 총괄 함수
        async function initHomePage(user) {
            try {
                const idToken = await user.getIdToken();
                
                // 유저 프로필 및 사주 데이터 병렬 로드
                const [userRes, sajuRes] = await Promise.allSettled([
                    loadUserProfile(idToken),
                    loadTodaySaju(idToken)
                ]);

                // 위치 설정 로드
                loadSavedLocation();
                
                // 맛집 정보 로드
                await fetchNearbyRestaurants(idToken);
                
            } catch (err) {
                if (isLocal) console.error("[Init Error]:", err);
            }
        }

        // 사용자 정보 로드 및 UI 업데이트 (프로필 사진, 닉네임, 생년월일)
        async function loadUserProfile(idToken) {
            try {
                const fields = ['nickname', 'birthDate', 'profileImage'];
                const res = await fetch(`${API_URL}/api/users/me?fields=${fields.join(',')}`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || errorData.detail || `사용자 정보 조회에 실패했습니다.`);
                }

                const userData = await res.json();
                
                // UI 업데이트
                userNameEl.textContent = `${userData.nickname}님` || '사용자님';
                userbirthdateEl.textContent = userData.birthDate || '';
                userProfileImageEl.src = userData.profileImage || '/assets/images/default-profile.jpg';
                nearbyRestaurantsHeading.textContent = `${userData.nickname}님 근처 맛집`;
            } catch (err) {
                if (isLocal) console.error("[UserProfile Load Error]:", err);
                //showCustomToast(`사용자 정보를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.`);
                // 오류 메시지 동기화
                userNameEl.textContent = '정보를 불러오지 못했습니다';
                userbirthdateEl.textContent = '';
            }
        }

        // 오늘의 사주 및 추천 메시지 로드
        async function loadTodaySaju(idToken) {
            try {
                const res = await fetch(`${API_URL}/api/saju`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (!res.ok) {
                    if (res.status === 404) {
                        throw new Error("오행 분석에 필요한 데이터가 아직 준비되지 않았습니다.");
                    }
                    throw new Error(`API 오류: ${res.status} ${res.statusText}`);
                }
                
                const sajuData = await res.json();

                const today = new Date();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                const day = today.getDate().toString().padStart(2, '0');

                recommendationTypeEl.textContent = `${month}/${day} 오늘의 운세`;
                recommendationHeadlineEl.textContent = sajuData.headline;
                recommendationAdviceEl.textContent = sajuData.advice;

                // 최종 보정 오행 비율
                updateSajuStats({
                    wood: sajuData.ohengScores['목(木)'] || 0,
                    fire: sajuData.ohengScores['화(火)'] || 0,
                    earth: sajuData.ohengScores['토(土)'] || 0,
                    metal: sajuData.ohengScores['금(金)'] || 0,
                    water: sajuData.ohengScores['수(水)'] || 0
                });
            } catch (err) {
                if (isLocal) console.error("[Saju Load Error]:", err); 
                //showCustomToast(`오늘의 운세를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.`);

                // 오류 메시지 동기화
                recommendationTypeEl.textContent = '정보 없음';
                recommendationHeadlineEl.textContent = '추천 분석 정보를 불러올 수 없습니다.';
                recommendationAdviceEl.textContent = '서버 오류가 발생했습니다.';
            }
        }

        // 오행 비율 바 업데이트 함수
        function updateSajuStats(stats) {
            const MAX_SCALING_VALUE = 60;

            for (const elementKey in stats) {
                const percentage = stats[elementKey];
                const element = statElements[elementKey];

                let scaledWidth = (percentage / MAX_SCALING_VALUE) * 100;

                if (scaledWidth > 100) {
                    scaledWidth = 100;
                }

                if (element && element.bar && element.value) {
                    element.bar.style.width = `${scaledWidth.toFixed(1)}%`;
                    element.value.textContent = Math.round(percentage);
                }
            }
        };

        // 로그인 인증 및 데이터 로드
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                initHomePage(user); // 로그인 시 홈 초기화 시작
            } else {
                window.location.href = '/index';
            }
        });

        /* =========================================================
        * 포춘쿠키
        * ======================================================= */
        // DOM 요소 정의
        const closedCookieSection = document.getElementById('closedCookieSection');
        const openedCookieSection = document.getElementById('openedCookieSection');
        const fortuneMessage = document.getElementById('fortuneMessage');
        const cookieActionButton = document.getElementById('cookieActionButton');

        // 상태 변수
        let isCookieOpened = false;

        const fortunes = [
            "오늘은 매운 음식을 먹어야 운이 풀려요! 새로운 곳을 탐험하세요.",
            "뜻밖의 행운이 찾아옵니다. 가장 친한 친구에게 연락해 보세요.",
            "오랜만에 만나는 친구와 즐거운 식사를 하세요. 행운이 따를 거예요.",
            "오늘은 달콤한 디저트가 행운을 가져다줍니다. 새로운 카페를 방문해 보세요.",
            "새로운 도전을 두려워하지 마세요. 용기가 큰 보상으로 돌아올 거예요.",
            "스트레스는 금물! 오늘은 편안한 식사를 하며 휴식을 취하세요.",
            "오늘은 따뜻한 한 끼가 운을 부릅니다. 마음 가는 음식을 선택해 보세요.",
            "가볍게 즐기는 식사가 오늘 하루를 부드럽게 풀어 줄 거예요.",
            "배를 너무 빵빵하게 채우기보다, 기분 좋아질 만큼만 먹으면 행운이 따를 거예요.",
            "느긋하게 천천히 씹어 먹으면 답답했던 마음이 조금씩 풀릴 거예요.",
            "좋아하는 음식을 한 번쯤 허용해 주세요. 작은 행복이 큰 운을 부릅니다.",
            "혼자 먹더라도 식탁을 예쁘게 차리면, 예상 못 한 좋은 소식이 찾아올 거예요.",
            "오늘 첫 끼를 즐겁게 먹으면 남은 하루의 흐름도 밝아집니다.",
            "배고픔을 오래 참지 말고 제때 챙겨 먹으면 생각지 못한 도움이 들어올 거예요.",
            "간단한 간식 하나가 지친 마음을 다독여 줄 거예요. 스스로를 조금은 챙겨 주세요.",
            "당이 살짝 떨어졌다면, 달콤한 한 입이 마음의 여유와 함께 행운도 데려올 거예요.",
            "오늘은 식사 시간만큼은 휴식 시간으로 정해 보세요. 그 여유가 좋은 인연을 불러옵니다.",
            "익숙한 맛의 식사가 불안한 마음을 안정시켜 줄 거예요. 편안한 메뉴를 골라 보세요.",
            "식사할 때 휴대폰을 잠시 내려두면, 머릿속이 맑아지고 좋은 아이디어가 떠오를 거예요.",
            "누군가와 음식을 나누어 먹으면, 그만큼 기쁨과 운도 나누어 돌아올 거예요.",
            "오늘 한 끼는 스스로를 응원하는 식사로 준비해 보세요. 자신감이 행운을 끌어당깁니다.",
            "물을 자주 마시며 식사 리듬을 맞추면 몸도 마음도 가벼워지고 일이 수월해질 거예요.",
            "식사 전에 오늘 잘 되고 싶은 일을 한 번 떠올리면, 그 에너지가 음식과 함께 스며들 거예요.",
            "배부름보다 ‘만족감’을 기준으로 식사를 마치면, 마음이 한결 단단해질 거예요.",
            "조용한 곳에서 차분히 먹는 한 끼가 흐트러진 운을 정리해 줄 거예요.",
            "오늘 마지막 한 입까지 감사한 마음으로 먹으면, 내일 맞이할 행운의 크기가 커집니다.",
        ];

        // 포춘 쿠키 열기 함수
        function openCookie() {
            if (!cookieActionButton || !fortuneMessage) return;

            isCookieOpened = true;

            const randomIndex = Math.floor(Math.random() * fortunes.length);
            fortuneMessage.textContent = fortunes[randomIndex];

            if (closedCookieSection) closedCookieSection.classList.add('hidden');
            if (openedCookieSection) openedCookieSection.classList.remove('hidden');

            cookieActionButton.textContent = '닫기';
            cookieActionButton.classList.remove('from-orange-400', 'to-red-500', 'text-white');
            cookieActionButton.classList.add('bg-gray-200', 'text-gray-800', 'bg-gradient-to-r');
        }

        // 포춘 쿠키 닫기/리셋 함수
        function closeCookie() {
            if (!cookieActionButton) return;

            isCookieOpened = false;

            if (openedCookieSection) openedCookieSection.classList.add('hidden');
            if (closedCookieSection) closedCookieSection.classList.remove('hidden');

            cookieActionButton.textContent = '열어보기';
            cookieActionButton.classList.remove('bg-gray-200', 'text-gray-800');
            cookieActionButton.classList.add('from-orange-400', 'to-red-500', 'text-white');
        }

        // 액션 버튼 클릭 시 상태에 따라 함수 실행
        if (cookieActionButton) {
            cookieActionButton.addEventListener('click', (e) => {
                e.preventDefault();
                if (isCookieOpened) {
                    closeCookie();
                } else {
                    openCookie();
                }
            });
        }

        // 핍압/모달 관련 로직
        const addChatBtn = document.getElementById('add-chat-btn');
        const addChatPopup = document.getElementById('add-chat-popup');
        const overlay = document.getElementById('overlay');

        const closeAllPopups = () => {
            overlay.classList.add('hidden');
            addChatPopup.classList.remove('popup-visible');
            addChatPopup.classList.add('popup-hidden');
        };

        addChatBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            const isAddChatOpen = addChatPopup.classList.contains('popup-visible');
            closeAllPopups();
            if (!isAddChatOpen) {
                overlay.classList.remove('hidden');
                addChatPopup.classList.remove('popup-hidden');
                addChatPopup.classList.add('popup-visible');
            }
        });

        overlay.addEventListener('click', closeAllPopups);

        /* =========================================================
         * 식당 카드 컨테이너 - PC 마우스 드래그 스크롤 (Drag to Scroll)
         * ======================================================= */
        const carousel = document.getElementById('restaurant-carousel');
        let isDown = false;
        let startX;
        let scrollLeft;

        carousel.addEventListener('mousedown', (e) => {
            isDown = true;
            carousel.classList.add('active');
            // 시작 지점 저장
            startX = e.pageX - carousel.offsetLeft;
            scrollLeft = carousel.scrollLeft;
        });

        carousel.addEventListener('mouseleave', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mouseup', () => {
            isDown = false;
            carousel.classList.remove('active');
        });

        carousel.addEventListener('mousemove', (e) => {
            if (!isDown) return; // 클릭 상태가 아니면 중단
            e.preventDefault();  // 기본 동작(텍스트 선택 등) 방지

            const x = e.pageX - carousel.offsetLeft;
            const walk = (x - startX) * 2; // 스크롤 속도 (숫자가 클수록 빠름)
            carousel.scrollLeft = scrollLeft - walk;
        });
    </script>
</body>

</html>