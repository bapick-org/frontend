<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>식당 상세 정보 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=85cfe1eb44a56817dcedc87a46b5070b&libraries=services"></script>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js" defer></script>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* 탭 버튼 스타일 */
        #scrap-btn.scrapped {
            background-color: #FF7A5A;
            color: white;
            border-color: #FF7A5A;
        }

        #scrap-btn.scrapped svg {
            fill: white;
        }

        header.scrolled {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
        }

        .tab-btn.active {
            color: #FF7A5A;
            border-color: #FF7A5A;
        }

        /* Swiper pagination (이미지 번호) */
        .swiper-pagination.swiper-pagination-fraction {
            width: auto;
            left: auto;
            right: 1.25rem;
            bottom: 1.25rem;

            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 99px;

            z-index: 20;
        }

        .detail-layout {
            display: block; /* 모바일 기본 한 줄 */
        }

        .detail-right {
            margin-top: 20px;
        }

        
        /* 1024px 이상 = PC 화면 */
        @media (min-width: 1024px) {
            .review-buttons {
                flex-direction: column;
            }

            .review-buttons a,
            .review-buttons button {
                width: 100%;
            }
        }

        @media (min-width: 1024px) {
            .detail-layout {
                display: grid;
                grid-template-columns: 1fr 400px; /* 왼쪽 flexible, 오른쪽 고정 */
                gap: 24px;
                height: calc(100vh - 150px); /* 화면 높이에 맞게 */
            }

            .detail-left {
                overflow-y: auto; /* 왼쪽만 스크롤 */
                padding-right: 10px;
            }

            .detail-right {
                position: sticky;
                top: 120px; /* 헤더 높이 */
                height: fit-content;
            }

            #map-area {
                width: 100%;
                height: 500px;
            }
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="w-full mx-auto h-full flex flex-col bg-white shadow-lg">
        
        <header id="page-header" class="grid grid-cols-3 items-center p-4 bg-white sticky top-0 z-20 transition-shadow duration-300">
            <div class="justify-self-start">
                <button id="back-button" class="p-2 text-gray-600 hover:bg-gray-100 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
            </div>
            <h1 id="header-title" class="text-xl font-bold text-center text-gray-800">식당 정보</h1>
            <div class="justify-self-end w-8"></div>
        </header>

        <!-- 메인 콘텐츠 (식당 요약 정보 / 탭 기반 상세 정보) -->
        <main id="main-content" class="flex-1 overflow-y-auto">
            <!-- 전체 레이아웃 (모바일 1열 / 데스크탑 1열)-->
            <div class="grid grid-cols-1 lg:grid-cols-3 lg:divide-x divide-gray-200">

                <!-- 식당 요약 정보 -->
                <div class="lg:col-span-1 p-5">

                    <!-- 식당 이미지 슬라이더 -->
                    <div class="relative w-full h-56 lg:h-72 mb-5">
                        <div id="image-swiper" class="swiper h-full">
                            <div class="swiper-wrapper"></div>
                            <div class="swiper-pagination"></div>
                        </div>
                    </div>

                    <!-- 식당 기본 정보 -->
                    <div class="p-0">
                        <p id="restaurant-category" class="inline-block bg-orange-100 text-[#FF7A5A] text-sm font-semibold px-3 py-1 rounded-full mb-2"></p>

                        <h2 id="restaurant-name" class="text-3xl font-bold text-gray-900 leading-tight"></h2>

                        <div id="review-info" class="flex items-center gap-4 text-lg text-gray-600 mt-3"></div>

                        <div class="mt-6 flex gap-2 review-buttons">
                            <button id="scrap-btn" class="flex-1 flex items-center justify-center gap-2 py-3 border-2 border-gray-200 bg-white text-gray-700 rounded-lg font-semibold transition-all duration-300 ease-in-out hover:shadow-md transform hover:-translate-y-0.5">
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.5 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0z" />
                                </svg>
                                <span>스크랩</span>
                            </button>

                            <a id="calender-btn" href="calender.html" class="flex-1 flex items-center justify-center gap-2 py-3 border-2 border-gray-200 bg-white text-gray-700 rounded-lg font-semibold transition-all duration-300 ease-in-out hover:shadow-md transform hover:-translate-y-0.5">
                                <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M19 4h-1V2h-2v2H8V2H6v2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/>
                                </svg>
                                <span>예약</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- 탭 기반 상세 정보 -->
                <div class="lg:col-span-2 pt-5 lg:pt-0">

                    <!-- 탭 네비게이션 -->
                    <div class="px-5 border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button class="tab-btn active py-4 px-1 text-center border-b-2 font-medium text-sm flex-1" data-tab="info">
                                상세정보
                            </button>
                            <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="menu">
                                메뉴
                            </button>
                            <button class="tab-btn py-4 px-1 text-center border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 font-medium text-sm flex-1" data-tab="facilities">
                                편의시설
                            </button>
                        </nav>
                    </div>

                    <!-- 탭 콘텐츠 -->
                    <div class="p-5">

                        <!-- 상세정보 탭 -->
                        <div id="info-panel" class="tab-panel space-y-5">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">기본 정보 및 위치</h3>
                            
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-8 text-center">
                                    <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-700">주소</p>
                                    <p id="restaurant-address" class="text-gray-600"></p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-8 text-center">
                                    <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-700">전화번호</p>
                                    <p id="restaurant-call" class="text-gray-600"></p>
                                </div>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-8 text-center">
                                    <svg class="w-6 h-6 text-gray-400 mx-auto" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-700">영업시간</p>
                                    <div id="restaurant-time" class="text-gray-600 space-y-1"></div>
                                </div>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pt-4 pb-2">지도</h3>
                            <div id="map" class="w-full h-72 rounded-lg border border-gray-200 overflow-hidden mt-4"></div>
                        </div>

                        <!-- 메뉴 탭 -->
                        <div id="menu-panel" class="tab-panel hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">메뉴 리스트</h3>
                            <ul id="menu-list" class="space-y-3"></ul>
                        </div>
                        
                        <!-- 편의시설 탭 -->
                        <div id="facilities-panel" class="tab-panel hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">제공 편의시설</h3>
                            <ul id="facilities-list" class="grid grid-cols-2 gap-3"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 토스트 -->
    <div id="custom-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-30 transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>

    <!-- 모달 오버레이 -->
    <div id="collection-overlay" class="fixed inset-0 bg-black bg-opacity-30 z-40 hidden transition-opacity duration-300"></div>
        
    <!-- 스크랩 시 컬렉션 선택 바텀 시트 -->
    <div id="collection-sheet" class="fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl shadow-xl transition-transform duration-300 ease-in-out transform translate-y-full">
        <div class="p-5 pt-4">
            <!-- 드래그 핸들 -->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <!-- 헤더 -->
            <h2 class="text-xl font-bold text-center text-gray-800 mb-2">
                컬렉션에 추가
            </h2>

            <!-- 컬렉션 리스트 -->
            <ul id="sheet-collection-list" class="max-h-60 overflow-y-auto divide-y divide-gray-100"></ul>

            <!-- 푸터 -->
            <div class="mt-4 pt-4 border-t border-gray-200">
                <button id="sheet-add-new-btn" class="w-full flex items-center justify-center gap-2 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    새 컬렉션 만들기
                </button>
            </div>
        </div>
    </div>

    <!-- 새 컬렉션 생성 바텀시트-->
    <div id="create-collection-sheet" class="fixed bottom-0 left-0 right-0 z-50 bg-white rounded-t-2xl shadow-xl transition-transform duration-300 ease-in-out transform translate-y-full">
        <div class="p-5 pt-4">
            <!-- 드래그 핸들-->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>

            <!-- 헤더 -->
            <h2 class="text-xl font-bold text-center text-gray-800 mb-6">
                새 컬렉션
            </h2>

            <!-- 입력 영역 -->
            <div class="space-y-4">
                <div>
                    <label for="collection-name" class="block text-sm font-medium text-gray-700 mb-1">컬렉션 이름</label>
                    <input type="text" id="collection-name" placeholder="컬렉션 이름 입력" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A]">
                </div>

                <button id="create-collection-btn" class="w-full px-4 py-3 bg-[#FF7A5A] text-white font-semibold rounded-lg hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-400 transition-colors">
                    만들기
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const fastapiUrl = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

        let currentRestaurant = null;
        let currentUser = null;

        // Header 관련 DOM 요소
        const backButton = document.getElementById('back-button');
        const headerTitle = document.getElementById('header-title');

        // 식당 관련 DOM 요소 
        const restaurantImageEl = document.getElementById('restaurant-image');
        const restaurantCategoryEl = document.getElementById('restaurant-category');
        const restaurantNameEl = document.getElementById('restaurant-name');
        const scrapBtn = document.getElementById('scrap-btn');
        const reviewInfo = document.getElementById('review-info');
        const restaurantAddressEl = document.getElementById('restaurant-address');
        const restaurantPhoneEl = document.getElementById('restaurant-call');
        const restaurantTimeEl = document.getElementById('restaurant-time');
        const mapContainer = document.getElementById('map');
        const menuListEl = document.getElementById('menu-list');
        const facilitiesListEl = document.getElementById('facilities-list');

        // 탭 관련 DOM 요소
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');

        // 컬렉션 관련 DOM 요소
        const collectionOverlay = document.getElementById('collection-overlay');
        const collectionSheet = document.getElementById('collection-sheet');
        const collectionListEl = document.getElementById('sheet-collection-list');
        const sheetAddNewBtn = document.getElementById('sheet-add-new-btn'); // 새 컬렉션 만들기 버튼
        
        // 커스텀 토스트 관련 DOM 요소
        const customToast = document.getElementById('custom-toast');
        const toastDuration = 2500; // 2.5초 후 사라짐

        // 컬렉션 생성 시트 관련 요소
        const createCollectionSheet = document.getElementById('create-collection-sheet');
        const createCollectionNameInput = document.getElementById('collection-name');
        const createCollectionBtn = document.getElementById('create-collection-btn'); // 만들기 버튼


        function showCustomToast(message) {
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

        // 지정된 시간 후 토스트 숨기기
            setTimeout(() => {
            customToast.classList.remove('opacity-100');
            customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }

        /* 이벤트 리스너 등록 */
        // 스크롤 시 헤더 고정 이벤트 리스너
        document.querySelector('main').addEventListener('scroll', (e) => {
            const header = document.getElementById('page-header');
            if (e.target.scrollTop > 50) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // 헤더의 뒤로가기 버튼 이벤트 리스너
        backButton.addEventListener('click', () => {
            history.back();
        });

        /* UI 렌더링 */
        // 스크랩 상태에 따라 스크랩 버튼 내 텍스트 업데이트
        function updateScrapButton(isScrapped) {
            if (isScrapped) {
                scrapBtn.classList.add('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩 완료';
            } else {
                scrapBtn.classList.remove('scrapped');
                scrapBtn.querySelector('span').textContent = '스크랩';
            }
        }

        /* API 호출 */
        // 해당 식당의 스크랩 상태 확인
        async function checkScrapStatus() {
            if (!currentUser || !currentRestaurant) return;
            try {
                const idToken = await currentUser.getIdToken(true);
                const response = await fetch(`${fastapiUrl}/api/scraps/restaurants/${currentRestaurant.id}`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || '스크랩 상태를 불러오지 못했습니다.');
                }

                const { isScrapped  } = await response.json();
                updateScrapButton(isScrapped);
            } catch (error) {
                if (isLocal) console.error("[스크랩 상태 확인 상태]:", error);
                showCustomToast(`스크랩 상태를 불러오지 못했습니다. 잠시 후 다시 시도해주세요.`);
            }
        }
        document.addEventListener('DOMContentLoaded', checkScrapStatus);

        // 스크랩 버튼 클릭 이벤트 리스너
        scrapBtn.addEventListener('click', async () => {
            if (!currentUser) return window.location.href = 'index.html';

            const isScrapped = scrapBtn.classList.contains('scrapped');
            const restaurantId = currentRestaurant.id;

            if (isScrapped) {
                // 1. 이미 스크랩된 경우: 스크랩 버튼을 누르면 스크랩 취소
                try {
                    const idToken = await currentUser.getIdToken(true);
                    const response = await fetch(`${fastapiUrl}/api/scraps/restaurants/${restaurantId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${idToken}` }
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.detail || '스크랩 취소에 실패했습니다.');
                    }

                    updateScrapButton(false);
                    showCustomToast('스크랩이 취소되었습니다.');
                } catch (error) {
                    if (isLocal) console.error("[스크랩 취소 실패]:", error);
                    showCustomToast('스크랩 취소에 실패했습니다.');
                }
            } else {
                // 2. 스크랩이 안 되어있는 경우: '컬렉션 선택' 바텀 시트 열기
                openCollectionSheet();
            }
        });

        // 탭 버튼 이벤트 리스너
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.getAttribute('data-tab');

                // 탭 버튼 활성화/비활성화
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]');
                    // PC 뷰에서 탭 클릭 시 스크롤 위치 보정
                    if (window.innerWidth >= 1024) {
                        document.querySelector('#main-content').scrollTop = 0;
                    }
                });
                button.classList.add('active', 'border-[#FF7A5A]', 'text-[#FF7A5A]');
                button.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                // 패널 표시/숨김
                tabPanels.forEach(panel => {
                    if (panel.id === `${targetTab}-panel`) {
                        panel.classList.remove('hidden');
                        // 지도 탭을 열 때 지도를 다시 렌더링하거나 레이아웃을 조정
                        if (targetTab === 'info' && currentRestaurant && currentRestaurant.latitude && currentRestaurant.longitude) {
                             // 카카오맵 re-layout 호출 (지도 표시 시 필수)
                            const mapContainer = document.getElementById('map');
                            if (mapContainer && window.kakao && window.kakao.maps) {
                                renderMap(parseFloat(currentRestaurant.latitude), parseFloat(currentRestaurant.longitude), currentRestaurant.name);
                            }
                        }
                    } else {
                        panel.classList.add('hidden');
                    }
                });
            });
        });

        // 식당 상세 정보 조회 api 호출 및 렌더링
        async function fetchRestaurantDetails(restaurantId, user) {
            if (!user) {
                console.error("fetchRestaurantDetails: User object is null.");
                return null;
            }

            const idToken = await user.getIdToken();

            if (!idToken) {
                window.location.href = 'index.html';
                return null;
            }

            try {
                const response = await fetch(`${fastapiUrl}/api/restaurants/detail/${restaurantId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.status === 404) {
                    throw new Error("식당 정보를 찾을 수 없습니다.");
                }
                if (!response.ok) {
                    throw new Error(`데이터 조회 오류: ${response.status} ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                alert(error.message); // 이 부분은 페이지 로딩 실패 알림이므로 alert 유지 (일반적인 오류 처리)
                return null;
            }
        }

        /* 식당 정보 렌더링 함수들 (이미지, 리뷰 정보, 메뉴, 편의시설, 운영시간) */
        function renderImage(image) {
            const defalutImages = '/assets/images/restaurant-default.png'; // 기본 이미지

            let images = [];

            if (typeof currentRestaurant.image === 'string' && currentRestaurant.image.trim() !== '') {
                images = currentRestaurant.image.split(',').map(url => url.trim());
            }

            const swiperWrapper = document.querySelector('.swiper-wrapper');
            const swiperContainer = document.querySelector('#image-swiper');

            swiperWrapper.innerHTML = '';

            // 이미지가 1장인 경우
            if (images.length === 1) {
                swiperContainer.classList.remove('swiper');
                swiperWrapper.innerHTML = `
                    <div class="w-full h-full">
                    <img src="${images[0]}" alt="식당 이미지" class="w-full h-full object-cover rounded-xl">
                    </div>
                `;
            // 이미지가 2장 이상인 경우
            } else if (images.length > 1) {
                swiperContainer.classList.add('swiper');
                images.forEach(imageUrl => {
                    const slide = document.createElement('div');
                    slide.className = 'swiper-slide';
                    slide.innerHTML = `<img src="${imageUrl}" alt="식당 이미지" class="w-full h-full object-cover rounded-xl">`;
                    swiperWrapper.appendChild(slide);
                });

                new Swiper('#image-swiper', {
                    loop: true,
                    pagination: {
                        el: '.swiper-pagination',
                        type: 'fraction',
                    },
                });

            // 가게 이미지가 없는 경우
            } else {
                swiperWrapper.innerHTML = `
                    <div class="w-full h-full">
                    <img src="${defalutImages}" alt="기본 이미지" class="w-full h-full object-cover rounded-xl">
                    </div>
                `;
            }
        }

        function renderReview(reviews) {
            reviewInfo.innerHTML = '';

            if (!reviews || reviews.length === 0) {
                reviewInfo.innerHTML = '';
                return;
            }

            reviewInfo.innerHTML = reviews.map(review => {
                let ratingInfo = '';
                if (review.rating) {
                    // [수정] 별점 텍스트 크기 키우기
                    ratingInfo = `<div class="flex items-center gap-1 text-xl">⭐<span class="font-bold">${review.rating}</span></div>`;
                }

                let visitorReviewsInfo = '';
                if (review.visitor_reviews > 0) {
                    // [수정] 방문자 리뷰 텍스트 크기 키우기
                    visitorReviewsInfo = `<div>방문자 리뷰 <span class="font-bold text-xl">${review.visitor_reviews}</span></div>`;
                }

                let blogReviewsInfo = '';
                if (review.blog_reviews > 0) {
                    // [수정] 블로그 리뷰 텍스트 크기 키우기
                    blogReviewsInfo = `<div>블로그 리뷰 <span class="font-bold text-xl">${review.blog_reviews}</span></div>`;
                }

                if (!ratingInfo && !visitorReviewsInfo && !blogReviewsInfo) {
                    return '';
                }

                return `
                    ${ratingInfo}${visitorReviewsInfo}${blogReviewsInfo}
                `;
            }).join('');
        }

        function renderMenus(menus) {
            menuListEl.innerHTML = '';

            if (!menus || menus.length === 0) {
                menuListEl.innerHTML = '<li class="text-gray-500 p-2 text-center">등록된 메뉴 정보가 없습니다.</li>';
                return;
            }

            menuListEl.innerHTML = menus.map(menu => {
                const menuName = menu.menu_name || menu.name || '';
                const menuPrice = menu.menu_price || menu.price || '';
                return `
                <li class="flex justify-between items-center p-3 bg-white border-b border-gray-100 last:border-b-0">
                    <span class="font-medium text-gray-700">${menuName}</span>
                    <span class="font-medium text-gray-700">${menuPrice}</span>
                </li>
            `;
            }).join('');
        }

        function renderHours(hours) {
            restaurantTimeEl.innerHTML = '';

            if (!hours || hours.length === 0) {
                restaurantTimeEl.innerHTML = '운영 시간 정보가 없습니다.';
                return;
            }

            const dayOrder = ['월', '화', '수', '목', '금', '토', '일'];
            hours.sort((a, b) => dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day));

            restaurantTimeEl.innerHTML = hours.map(hour => {
                let mainTimeInfo = '';
                let additionalInfo = '';

                if (hour.is_closed) {
                    mainTimeInfo = `<span class="text-red-500 font-bold">휴무</span>`;
                } else if (hour.open_time && hour.close_time) {
                    mainTimeInfo = `${hour.open_time.substring(0, 5)} - ${hour.close_time.substring(0, 5)}`;
                } else {
                    mainTimeInfo = '정보 없음';
                }

                let lastOrderInfo = '';
                if (hour.last_order) {
                    lastOrderInfo = ` (라스트 오더: ${hour.last_order.substring(0, 5)})`;
                }

                let breakInfo = '';
                if (hour.break_start && hour.break_end) {
                    breakInfo = `<span class="text-xs text-gray-500">브레이크: ${hour.break_start.substring(0, 5)} - ${hour.break_end.substring(0, 5)}</span>`;
                }

                if (breakInfo) {
                    additionalInfo = `
                    <div class="flex flex-col pt-0.5">
                        ${breakInfo}
                    </div>
                `;
                }

                return `
                <div class="flex flex-col py-1">
                    <div class="flex items-center text-sm gap-4">
                        <span class="font-medium text-gray-700 w-2 flex-shrink-0">${hour.day}</span>
                        <div class="flex-1">
                            <span>${mainTimeInfo}${lastOrderInfo}</span>
                            <span>${additionalInfo}</span>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderFacilities(facilities) {
            facilitiesListEl.innerHTML = '';

            if (!facilities || facilities.length === 0) {
                facilitiesListEl.innerHTML = '<li class="col-span-2 text-gray-500 p-2 text-center">등록된 편의시설 정보가 없습니다.</li>';
                return;
            }

            facilitiesListEl.innerHTML = facilities.map(facility => {
                const facilityName = facility.name || '정보 없음';
                return `
                <li class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg text-sm text-gray-700 font-medium">
                    <svg class="w-4 h-4 text-[#FF7A5A] flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>
                    <span>${facilityName}</span>
                </li>
            `;
            }).join('');
        }

        // 해당 식당의 위도/경도를 통해 지도 렌더링 
        function renderMap(lat, lon, name) {
            if (!window.kakao || !window.kakao.maps) {
                console.error("Kakao Map SDK가 로드되지 않았습니다.");
                return;
            }

            const mapContainer = document.getElementById('map');
            
            if (!mapContainer) return;

            const mapOption = {
                center: new kakao.maps.LatLng(lat, lon), // 식당 좌표를 지도의 중심으로 설정
                level: 3 // 지도의 확대 레벨
            };

            const map = new kakao.maps.Map(mapContainer, mapOption); // 지도 생성

            // 마커 생성 후 지도에 표시
            const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(lat, lon),
                map: map
            });
            
            // 지도가 화면에 나타날 때 지도를 새로고침하는 함수 (탭 전환 시 필요)
            setTimeout(() => map.relayout(), 100); 
            kakao.maps.event.addListener(map, 'idle', function() {
                map.relayout();
            });
        }

        // 메인 함수
        async function loadRestaurantDetails(user) {
            const urlParams = new URLSearchParams(window.location.search);
            const restaurantId = urlParams.get('id');

            if (!restaurantId) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-red-500">잘못된 접근입니다: 식당 ID가 없습니다.</div>';
                return;
            }

            const details = await fetchRestaurantDetails(restaurantId, user);
            if (!details) {
                document.getElementById('main-content').innerHTML = '<div class="p-4 text-center text-gray-600">식당 정보를 불러오는 데 실패했습니다.</div>';
                return;
            }

            currentRestaurant = details;
            
            // 헤더 타이틀 업데이트
            headerTitle.textContent = currentRestaurant.name || '식당 정보';
            
            // 브라우저 탭 타이틀 업데이트 (<title>)
            document.title = `${currentRestaurant.name} - Bapick`;

            // 기본 정보 ui 업데이트 (이름, 카테고리, 주소, 전화번호 )
            restaurantNameEl.textContent = currentRestaurant.name || '이름 정보 없음';
            restaurantCategoryEl.textContent = currentRestaurant.category || '카테고리';
            restaurantAddressEl.textContent = currentRestaurant.address || '주소 정보 없음';
            restaurantPhoneEl.textContent = currentRestaurant.phone || '전화번호 정보 없음';

            renderImage(currentRestaurant.image); // 이미지
            renderHours(currentRestaurant.hours); // 운영 시간
            renderReview(currentRestaurant.reviews); // 리뷰
            renderMenus(currentRestaurant.menus); // 메뉴
            renderFacilities(currentRestaurant.facilities); // 편의시설
            
            // 지도 렌더링 (DOM 로드 후 바로 실행)
            renderMap(parseFloat(currentRestaurant.latitude), parseFloat(currentRestaurant.longitude), currentRestaurant.name);
            
            checkScrapStatus(); // 해당 식당의 스크랩 상태 확인
        }

        // 컬렉션 리스트 아이템 생성 및 스크랩 로직 처리
        function createCollectionListItem(collection) { 
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 cursor-pointer';

            const nameClass = collection.name == '모든 스크랩'
                ? 'font-bold text-orange-500'
                : 'font-medium text-gray-800';

            li.className = 'flex items-center justify-between p-4 border-b border-gray-100 last:border-b-0 hover:bg-gray-50 cursor-pointer';
            li.dataset.collectionId = collection.id; // 컬렉션 ID를 저장
            
            li.innerHTML = `
                <span class="${nameClass}">${collection.name}</span>
                <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path>
                </svg>
            `;

            // 컬렉션 요소(li) 클릭 이벤트: 해당 컬렉션으로 스크랩
            li.addEventListener('click', async () => {
                li.classList.add('opacity-50', 'pointer-events-none'); 

                const collectionId = li.dataset.collectionId; 
                
                try {
                    const idToken = await currentUser.getIdToken(true);
                    const restaurantId = currentRestaurant.id;

                    const response = await fetch(`${fastapiUrl}/api/scraps/restaurants/${currentRestaurant.id}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            restaurant_id: restaurantId,
                            collection_id: (collectionId && parseInt(collectionId) !== 0) ? parseInt(collectionId) : null
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || errorData.detail || '스크랩에 실패했습니다.');
                    }

                    updateScrapButton(true); // 스크랩 버튼 UI 업데이트
                    closeCollectionSheet(); // 시트 닫기
                    showCustomToast(`'${collection.name}'에 스크랩되었습니다.`);
                } catch (error) {
                    if (isLocal) console.error("[스크랩 등록 실패]:", error);
                    showCustomToast('스크랩 등록에 실패했습니다.');
                } finally {
                    li.classList.remove('opacity-50', 'pointer-events-none');
                }
            });
            return li;
        }

        // 컬렉션 목록을 받아와 바텀 시트에 렌더링하는 함수
        async function fetchAndRenderCollections() { 
            const listContainer = document.getElementById('sheet-collection-list');
            listContainer.innerHTML = '<li class="p-3 text-center text-gray-500">컬렉션 목록 불러오는 중...</li>';

            if (!currentUser) {
                listContainer.innerHTML = '<li class="p-3 text-center text-red-500">로그인이 필요합니다.</li>';
                return;
            }

            try {
                const token = await currentUser.getIdToken();
                
                const response = await fetch(`${fastapiUrl}/api/collections`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || '컬렉션 목록 조회에 실패했습니다.');
                }
                
                const userCollections = await response.json();
                
                listContainer.innerHTML = ''; 
                
                userCollections.forEach(collection => {
                    listContainer.appendChild(createCollectionListItem(collection));
                });
                
            } catch (error) {
                if (isLocal) console.error("[컬렉션 목록 조회 실패]:", error);
                listContainer.innerHTML = '<li class="p-3 text-center text-red-500">목록을 불러오지 못했습니다.</li>';
            }
        }

        // 오버레이 클릭 이벤트 리스너
        collectionOverlay.addEventListener('click', closeCollectionSheet);

        // 바텀 시트 open
        function openCollectionSheet() { 
            if (!currentUser) {
                showCustomToast("로그인이 필요합니다.");
                return;
            }
            
            fetchAndRenderCollections();

            collectionOverlay.classList.remove('hidden');
            collectionSheet.classList.add('sheet-visible');
            collectionSheet.classList.remove('translate-y-full');
            
            createCollectionSheet.classList.remove('sheet-visible');
            createCollectionSheet.classList.add('translate-y-full');
        }

        // 바텀 시트 close (모든 시트 닫기)
        function closeCollectionSheet() { 
            collectionOverlay.classList.add('hidden');
            
            collectionSheet.classList.remove('sheet-visible');
            collectionSheet.classList.add('translate-y-full');
            
            createCollectionSheet.classList.remove('sheet-visible');
            createCollectionSheet.classList.add('translate-y-full');
        }

        // [신규] '새 컬렉션 만들기' 버튼 클릭 시 -> 목록 시트 닫고 생성 시트 열기
        sheetAddNewBtn.addEventListener('click', () => { 
            collectionSheet.classList.remove('sheet-visible');
            collectionSheet.classList.add('translate-y-full');
            
            createCollectionSheet.classList.remove('translate-y-full');
            createCollectionSheet.classList.add('sheet-visible');
            
            createCollectionNameInput.value = '';
            setTimeout(() => createCollectionNameInput.focus(), 300);
        });

        // '컬렉션 만들기' 버튼 클릭 이벤트 리스너
        createCollectionBtn.addEventListener('click', async () => { 
            const name = createCollectionNameInput.value.trim();
            if (!name) {
                showCustomToast('컬렉션 이름을 입력해주세요.');
                return;
            }

            if (!currentUser) return;

            try {
                const idToken = await currentUser.getIdToken(true);
                
                const response = await fetch(`${fastapiUrl}/api/collections`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: name })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || errorData.detail || '컬렉션 생성에 실패했습니다.');
                }

                showCustomToast('새 컬렉션이 생성되었습니다.');
                    
                createCollectionSheet.classList.remove('sheet-visible');
                createCollectionSheet.classList.add('translate-y-full');

                await fetchAndRenderCollections();
                    
                collectionSheet.classList.remove('translate-y-full');
                collectionSheet.classList.add('sheet-visible');
                    
            } catch (error) {
                if (isLocal) console.error('컬렉션 생성 중 오류:', error);
                showCustomToast('컬렉션 생성 중 오류가 발생했습니다.');
            }
        });

        // 로그인 인증
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadRestaurantDetails(user);
            } else {
                window.location.href = 'index.html';
            }
        });

    </script>
</body>
</html>