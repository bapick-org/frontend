<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밥픽 - 프로필 편집</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-white">
    
    <div id="custom-toast"
        class="fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>
    
    <div class="h-full flex flex-col">
        
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200 flex-shrink-0">
            <div>
                <a href="mypage.index.html" class="text-gray-600 hover:text-gray-900">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
                </a>
            </div>
            <h1 class="text-xl font-bold text-center text-gray-800">프로필 편집</h1>
            <div class="justify-self-end"><div class="w-6 h-6"></div></div>
        </header>

        
        <main class="flex-1 overflow-y-auto bg-white p-6 flex flex-col">
            <div class="max-w-md w-full mx-auto flex-1 flex flex-col">
                <div class="flex justify-center mb-10">
                    <div class="relative">
                        <img id="profile-image-preview" class="w-32 h-32 rounded-full object-cover" src="https://bapick-s3-bucket.s3.ap-northeast-2.amazonaws.com/default/default_profile.png" alt="프로필 사진">
                        <label for="profile-image-upload" class="absolute -bottom-2 -right-2 w-10 h-10 bg-[#FF7A5A] rounded-full flex justify-center items-center cursor-pointer shadow-md hover:bg-orange-600 transition">
                            <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,19H5V5H15V3H5C3.89,3,3,3.9,3,5V19C3,20.1,3.9,21,5,21H19C20.1,21,21,20.1,21,19V9H19V19ZM17,3V7H21V3H17ZM14.12,11.45L12.71,13.23L15,16H9L11.29,13.09L10.29,11.82L6,17H18L14.12,11.45Z"></path></svg>
                        </label>
                        <input type="file" id="profile-image-upload" class="hidden" accept="image/*">
                    </div>
                </div>
    
                <div class="mb-6">
                    <label for="nickname" class="block text-sm font-medium text-gray-500 mb-2">닉네임</label>
                    <input type="text" id="nickname" placeholder="사용하실 닉네임을 입력하세요" class="w-full p-3.5 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A] focus:border-transparent">
                </div>
                
                <button id="save-profile-btn" class="w-full p-4 bg-[#FF7A5A] text-white text-base font-bold rounded-xl cursor-pointer mt-auto disabled:bg-gray-400 transition">저장</button>
                
            </div>
        </main>
        
        </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";
        import Compressor from 'https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.esm.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const fastapiUrl = "https://bapick.duckdns.org"

        const profileImageUpload = document.getElementById('profile-image-upload');
        const profileImagePreview = document.getElementById('profile-image-preview');
        const nicknameInput = document.getElementById('nickname');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        // ❌ messageModal, messageText, closeBtn 변수는 삭제되었습니다.

        // ✅ [추가] 토스트 관련 변수 정의
        const customToast = document.getElementById('custom-toast');
        const toastDuration = 2500; 
        
        let currentUser = null;
        let selectedFile = null;
        
        // ✅ [추가] 커스텀 토스트 함수 정의 (기존 showMessage, closeModal 대체)
        function showCustomToast(message) {
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

            setTimeout(() => {
                customToast.classList.remove('opacity-100');
                customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }

        // 로그인 확인
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user);
            } else {
                window.location.href = 'index.html';
            }
        });

        // ❌ 기존 showMessage, closeModal 함수는 삭제되었습니다.
        // ❌ closeBtn.addEventListener('click', closeModal); 이벤트 리스너는 삭제되었습니다.

        // 유저 정보 로드
        async function loadUserProfile(user) {
            try {
                const idToken = await user.getIdToken();

                const fields = ['nickname', 'profileImage'];
                const res = await fetch(`${fastapiUrl}/api/users/me?fields=${fields.join(',')}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                if (!res.ok) throw new Error(`API error: ${res.status}`);
                const data = await res.json();

                // UI 업데이트
                nicknameInput.value = data.nickname || '';
                profileImagePreview.src = data.profileImage;
            } catch (err) {
                console.error('유저 정보 로드 실패:', err);
                // loadUserProfile 실패는 치명적이므로, 필요시 토스트로 알림 가능
            }
        }

        // 이미지 선택 시 미리보기
        profileImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    profileImagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        saveProfileBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = '저장 중...';

            let profile_image_s3_key = null;

            try {
                const idToken = await currentUser.getIdToken();

                // Compressor로 압축 후 Pre-signed URL 업로드
                if (selectedFile) {
                    const compressedFile = await new Promise((resolve, reject) => {
                        new Compressor(selectedFile, {
                            quality: 0.1,
                            maxWidth: 1024,
                            maxHeight: 1024,
                            success(result) { resolve(result); },
                            error(err) { reject(err); }
                        });
                    });

                    // Pre-signed URL 요청
                    const presignRes = await fetch(`${fastapiUrl}/api/users/generate-presigned-url`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${idToken}` },
                        body: new URLSearchParams({
                            filename: compressedFile.name,
                            content_type: compressedFile.type
                        })
                    });
                    if (!presignRes.ok) throw new Error('Presigned URL 생성 실패');
                    const { presigned_url, s3_key } = await presignRes.json();
                    profile_image_s3_key = s3_key;

                    // 브라우저에서 S3 직접 업로드
                    const uploadRes = await fetch(presigned_url, {
                        method: 'PUT',
                        headers: { 'Content-Type': compressedFile.type },
                        body: compressedFile
                    });
                    if (!uploadRes.ok) throw new Error('S3 업로드 실패');
                }

                // PATCH로 닉네임/이미지 key 전송
                const patchData = new URLSearchParams();
                const newNickname = nicknameInput.value.trim();
                if (newNickname) patchData.append('nickname', newNickname);
                if (profile_image_s3_key) patchData.append('profile_image_s3_key', profile_image_s3_key);

                const patchRes = await fetch(`${fastapiUrl}/api/users/me`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${idToken}` },
                    body: patchData
                });
                if (!patchRes.ok) throw new Error('회원 정보 수정 실패');
                const patchResult = await patchRes.json();

                // UI 갱신
                if (patchResult.profile_image) profileImagePreview.src = patchResult.profile_image;
                if (patchResult.nickname) nicknameInput.value = patchResult.nickname;

                // ✅ [수정] 성공 알림: showMessage 대신 토스트 사용
                showCustomToast('프로필 편집이 완료됐습니다.'); 
                selectedFile = null; // 완료 후 초기화
            } catch (err) {
                console.error(err);
                // ✅ [수정] 실패 알림: alert() 대신 토스트 사용
                showCustomToast(`프로필 편집 실패: ${err.message}`);
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = '저장';
            }
        });
    </script>
</body>
</html>