<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/icons/favicon-16x16.png">
    <link rel="manifest" href="/assets/icons/site.webmanifest">
    <link rel="shortcut icon" href="/assets/icons/favicon.ico">
    <title>프로필 편집 - Bapick</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    </style>
</head>
<body class="bg-white">    
    <div class="h-full flex flex-col">
        <header class="grid grid-cols-3 items-center p-4 border-b border-gray-200 flex-shrink-0">
            <a href="mypage.index.html" class="text-gray-600 hover:text-gray-900">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 19l-7-7 7-7"/></svg>
            </a>
            <h1 class="text-xl font-bold text-center text-gray-800">프로필 편집</h1>
        </header>
        
        <main class="flex-1 overflow-y-auto bg-white p-6 flex flex-col">
            <div class="max-w-md w-full mx-auto flex-1 flex flex-col">
                <div class="flex justify-center mb-10">
                    <div class="relative">
                        <img id="profile-image-preview" class="w-32 h-32 rounded-full object-cover" src="/assets/images/default-profile.jpg" alt="프로필 사진">
                        <label for="profile-image-upload" class="absolute -bottom-2 -right-2 w-10 h-10 bg-[#FF7A5A] rounded-full flex justify-center items-center cursor-pointer shadow-md hover:bg-orange-600 transition">
                            <svg class="w-6 h-6 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19,19H5V5H15V3H5C3.89,3,3,3.9,3,5V19C3,20.1,3.9,21,5,21H19C20.1,21,21,20.1,21,19V9H19V19ZM17,3V7H21V3H17ZM14.12,11.45L12.71,13.23L15,16H9L11.29,13.09L10.29,11.82L6,17H18L14.12,11.45Z"></path></svg>
                        </label>
                        <input type="file" id="profile-image-upload" class="hidden" accept=".jpg, .jpeg, .png, .webp">
                    </div>
                </div>
    
                <div class="mb-6">
                    <label for="nickname" class="block text-sm font-medium text-gray-500 mb-2">닉네임</label>
                    <input type="text" id="nickname" placeholder="사용하실 닉네임을 입력하세요" class="w-full p-3.5 text-base border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF7A5A] focus:border-transparent">
                </div>
                
                <button id="save-profile-btn" class="w-full p-4 bg-[#FF7A5A] text-white text-base font-bold rounded-xl cursor-pointer mt-auto disabled:bg-gray-400 transition">
                    저장
                </button>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div id="custom-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-gray-800 text-white text-sm font-medium rounded-lg shadow-lg z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
        알림 메시지
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { firebaseConfig } from "./firebase-config.js";
        import Compressor from 'https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.esm.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocal ? "http://127.0.0.1:8000" : "https://bapick.duckdns.org";

        const profileImageUpload = document.getElementById('profile-image-upload');
        const profileImagePreview = document.getElementById('profile-image-preview');
        const nicknameInput = document.getElementById('nickname');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const customToast = document.getElementById('custom-toast');

        let currentUser = null;
        let selectedFile = null;
        const toastDuration = 2500; 
        
        // 커스텀 토스트 함수 정의
        function showCustomToast(message) {
            customToast.textContent = message;
            customToast.classList.remove('opacity-0', 'pointer-events-none');
            customToast.classList.add('opacity-100');

            setTimeout(() => {
                customToast.classList.remove('opacity-100');
                customToast.classList.add('opacity-0', 'pointer-events-none');
            }, toastDuration);
        }

        // 로그인 확인
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user);
            } else {
                showCustomToast("로그인이 필요한 페이지입니다. 로그인 페이지로 이동합니다.");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        });

        // 유저 정보 조회 (프로필 이미지, 닉네임)
        async function loadUserProfile(user) {
            try {
                const idToken = await user.getIdToken();

                // 1. 필요한 필드만 쿼리 파라미터로 요청
                const fields = ['nickname', 'profileImage'];
                const res = await fetch(`${API_URL}/api/users/me?fields=${fields.join(',')}`, {
                    headers: {
                        'Authorization': `Bearer ${idToken}`
                    }
                });

                // 2. 표준 에러 규격 처리
                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.message || `프로필 로드에 실패했습니다.`);
                }

                const data = await res.json();

                // 3. 닉네임 업데이트
                if (data.nickname !== undefined) {
                    nicknameInput.value = data.nickname;
                }

                // 4. 프로필 이미지 처리: data.profileImage가 null이면 로컬의 default-profile.jpg를 사용
                profileImagePreview.src = data.profileImage || '/assets/images/default-profile.jpg';
            } catch (err) {
                if (typeof showCustomToast === 'function') {
                    showCustomToast(`프로필 정보를 불러오지 못했습니다: ${err.message}`);
                }
            }
        }

        // 이미지 선택 시 파일 검증 및 미리보기
        profileImageUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            // 1. 확장자 추출 및 검증
            const allowedExtensions = ['jpg', 'jpeg', 'png', 'webp'];
            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (!allowedExtensions.includes(fileExtension)) {
                showCustomToast("허용되지 않는 파일 형식입니다. (jpg, jpeg, png, webp만 가능합니다.)");
                profileImageUpload.value = '';
                return;
            }

            // 2. 미리보기 실행
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                profileImagePreview.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
        
        // 프로필 이미지 저장
        saveProfileBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = '저장 중...';

            let profileImageS3Key = null;

            try {
                const idToken = await currentUser.getIdToken();

                // 1. S3에 프로필 이미지 업로드
                if (selectedFile) {
                    // 1) Compressor.js로 이미지 압축
                    const compressedFile = await new Promise((resolve, reject) => {
                        new Compressor(selectedFile, {
                            quality: 0.1,
                            maxWidth: 512,
                            maxHeight: 512,
                            success(result) { resolve(result); },
                            error(err) { reject(err); }
                        });
                    });

                    // 2) 백엔드에 Presigned URL 생성 요청
                    const presignRes = await fetch(`${API_URL}/api/users/me/presigned-url`, {
                        method: 'POST',
                        headers: { 
                            'Authorization': `Bearer ${idToken}`,
                            'Content-Type': 'application/json' 
                        },
                        body: JSON.stringify({ 
                            fileName: compressedFile.name,
                            contentType: compressedFile.type
                        })
                    });

                    if (!presignRes.ok) {
                        const errorData = await presignRes.json();
                        throw new Error(errorData.message || '일시적인 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.');
                    }

                    // 기본값(null 할당): undefined가 URL 문자열로 변환되어 잘못된 요청(405 에러)이 가는 것을 방지
                    const { presignedUrl = null, s3Key = null } = await presignRes.json();

                    // 응답은 성공했으나 필요한 데이터가 누락될 경우
                    if (!presignedUrl || !s3Key) {
                        throw new Error('업로드 경로 설정 중 오류가 발생했습니다.');
                    }
                    profileImageS3Key = s3Key;

                    // 브라우저에서 S3 직접 업로드
                    const uploadRes = await fetch(presignedUrl, {
                        method: 'PUT',
                        headers: { 'Content-Type': compressedFile.type },
                        body: compressedFile
                    });
                    if (!uploadRes.ok) throw new Error('이미지 파일 전송에 실패했습니다. 네트워크 상태를 확인해 주세요.');
                }

                // 2. PATCH로 닉네임/이미지 key 전송
                const patchBody = {};
                const newNickname = nicknameInput.value.trim();
                
                if (newNickname) patchBody.nickname = newNickname;
                if (profileImageS3Key) patchBody.profileImageS3Key = profileImageS3Key;

                const patchRes = await fetch(`${API_URL}/api/users/me`, {
                    method: 'PATCH',
                    headers: { 
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(patchBody)
                });

                if (!patchRes.ok) {
                    const errorData = await patchRes.json();
                    throw new Error(errorData.message || '회원 정보 수정에 실패했습니다.');
                }
                const patchResult = await patchRes.json();

                // UI 갱신
                if (patchResult.profile_image) profileImagePreview.src = patchResult.profileImage;
                if (patchResult.nickname) nicknameInput.value = patchResult.nickname;

                showCustomToast('프로필 편집이 완료됐습니다.'); 
                selectedFile = null;
            } catch (err) {
                showCustomToast(err.message);
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = '저장';
            }
        });
    </script>
</body>
</html>